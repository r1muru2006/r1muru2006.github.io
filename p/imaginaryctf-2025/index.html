<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Đây là các chall mình giải được trong quá trình thi cùng team aespaFanClub."><title>ImaginaryCTF 2025</title><link rel=canonical href=https://r1muru2006.github.io/p/imaginaryctf-2025/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="ImaginaryCTF 2025"><meta property='og:description' content="Đây là các chall mình giải được trong quá trình thi cùng team aespaFanClub."><meta property='og:url' content='https://r1muru2006.github.io/p/imaginaryctf-2025/'><meta property='og:site_name' content='r1muru'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='CTF'><meta property='article:tag' content='Cryptography'><meta property='article:published_time' content='2025-09-14T14:17:02+07:00'><meta property='article:modified_time' content='2025-09-14T14:17:02+07:00'><meta property='og:image' content='https://r1muru2006.github.io/p/imaginaryctf-2025/imaginary.jpg'><meta name=twitter:title content="ImaginaryCTF 2025"><meta name=twitter:description content="Đây là các chall mình giải được trong quá trình thi cùng team aespaFanClub."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://r1muru2006.github.io/p/imaginaryctf-2025/imaginary.jpg'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/r1muru_hu_96d524052e0dfddb.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>r1muru</a></h1><h2 class=site-description>Life is not fair, get used to it!</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#leaky-rsa>leaky-rsa</a><ol><li><a href=#phân-tích-và-lời-giải>Phân tích và lời giải</a></li></ol></li><li><a href=#zkpow>zkpow</a><ol><li><a href=#phân-tích-và-lời-giải-1>Phân tích và lời giải</a></li></ol></li><li><a href=#scalar-division>scalar-division</a><ol><li><a href=#phân-tích-và-lời-giải-2>Phân tích và lời giải</a></li></ol></li><li><a href=#redacted>redacted</a><ol><li><a href=#phân-tích-và-lời-giải-3>Phân tích và lời giải</a></li></ol></li><li><a href=#leaky-rsa-revenge>leaky-rsa-revenge</a><ol><li><a href=#phân-tích>Phân tích</a></li><li><a href=#hướng-giải>Hướng giải</a></li></ol></li><li><a href=#clcg>clcg</a><ol><li><a href=#phân-tích-đề-bài>Phân tích đề bài</a></li><li><a href=#hướng-giải-1>Hướng giải</a><ol><li><a href=#khai-thác-từ-lcg-cho-trước>Khai thác từ LCG cho trước</a></li><li><a href=#khôi-phục-lại-delta-s_t>Khôi phục lại $\Delta S_t$</a></li></ol></li></ol></li><li><a href=#bigger-rsa>Bigger-RSA</a></li><li><a href=#tài-liệu>Tài liệu</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/imaginaryctf-2025/><img src=/p/imaginaryctf-2025/imaginary_hu_9f676c41f261ac38.jpg srcset="/p/imaginaryctf-2025/imaginary_hu_9f676c41f261ac38.jpg 800w, /p/imaginaryctf-2025/imaginary_hu_a268d31ddb9b80e1.jpg 1600w" width=800 height=800 loading=lazy alt="Featured image of post ImaginaryCTF 2025"></a></div><div class=article-details><header class=article-category><a href=/categories/ctf-write-up/>CTF Write-Up</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/imaginaryctf-2025/>ImaginaryCTF 2025</a></h2><h3 class=article-subtitle>Đây là các chall mình giải được trong quá trình thi cùng team aespaFanClub.</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 14, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>23 minute read</time></div></footer></div></header><section class=article-content><blockquote><p>Shout out to others member for trying their best and reached the top 15 of the world, ranked 1st University of Technology.</p></blockquote><h2 id=leaky-rsa>leaky-rsa</h2><p><img src=https://hackmd.io/_uploads/HJRRJ-hqxl.png loading=lazy alt=image>
<code>chall.py</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/local/bin/python3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>getPrime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.Padding</span> <span class=kn>import</span> <span class=n>pad</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>secrets</span> <span class=kn>import</span> <span class=n>randbelow</span><span class=p>,</span> <span class=n>token_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>sha256</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;flag.txt&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>getPrime</span><span class=p>(</span><span class=mi>512</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>getPrime</span><span class=p>(</span><span class=mi>512</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=n>p</span> <span class=o>*</span> <span class=n>q</span>
</span></span><span class=line><span class=cl><span class=n>e</span> <span class=o>=</span> <span class=mi>65537</span>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=n>p</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>q</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key_m</span> <span class=o>=</span> <span class=n>randbelow</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key_c</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>key_m</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>key_m</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ct</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>IV</span><span class=o>=</span><span class=n>iv</span><span class=p>)</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>pad</span><span class=p>(</span><span class=n>flag</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span> <span class=mi>16</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;n&#39;</span><span class=p>:</span> <span class=n>n</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=n>key_c</span><span class=p>,</span> <span class=s1>&#39;iv&#39;</span><span class=p>:</span> <span class=n>iv</span><span class=o>.</span><span class=n>hex</span><span class=p>(),</span> <span class=s1>&#39;ct&#39;</span><span class=p>:</span> <span class=n>ct</span><span class=o>.</span><span class=n>hex</span><span class=p>()}))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_bit</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=n>k</span><span class=p>)</span> <span class=o>%</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1024</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>randbelow</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;idx&#39;</span><span class=p>:</span> <span class=n>idx</span><span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=nb>input</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;c&#39;</span><span class=p>]</span> <span class=o>%</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>c</span> <span class=o>!=</span> <span class=n>key_c</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=n>get_bit</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>,</span> <span class=ne>TypeError</span><span class=p>,</span> <span class=ne>KeyError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>,</span> <span class=ne>AssertionError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=n>b</span><span class=p>}))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>key_m</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=phân-tích-và-lời-giải>Phân tích và lời giải</h3><p>Nhìn sơ qua thì đây là một bài ứng dụng thuật AES-RSA</p><p>Sơ đồ chính của thử thách là:
Random <code>key_m</code> bé hơn n -> dùng <code>key_m</code> mã hóa flag thành <code>ct</code> bằng AES mode CBC.
Mặt khác: Dùng RSA mã hóa <code>key_m</code> thành <code>key_c</code>
Cuối cùng tiết lộ <code>n, key_c, iv, ct</code> và cho ta gửi 1024 bản mã. Với mỗi bản mã, tiết lộ 1 bit nằm trong khoảng vị trí thứ 0 đến 3 từ phải qua sau khi giải mã với thuật RSA.</p><p>Tuy nhiên trong bài này, <code>key_m</code> đã bị leak khi hoàn thành 1024 bản mã và thế là ta có thể giải mã được AES mode CBC ngay</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># solution.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.Padding</span> <span class=kn>import</span> <span class=n>unpad</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>sha256</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># io = process([&#39;python3&#39;, &#39;chall.py&#39;])</span>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;leaky-rsa.chal.imaginaryctf.org&#34;</span><span class=p>,</span> <span class=mi>1337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>n</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ct</span><span class=p>,</span> <span class=n>c</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;n&#39;</span><span class=p>],</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;iv&#39;</span><span class=p>]),</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;ct&#39;</span><span class=p>]),</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;c&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1024</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>())[</span><span class=s1>&#39;idx&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>send</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>())[</span><span class=s1>&#39;b&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key_m</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>key_m</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=n>unpad</span><span class=p>(</span><span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>IV</span><span class=o>=</span><span class=n>iv</span><span class=p>)</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>ct</span><span class=p>),</span> <span class=mi>16</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><pre><code>Flag: ictf{p13cin9_7h3_b1t5_t0g37her_3f0068c1b9be2547ada52a8020420fb0}
</code></pre><h2 id=zkpow>zkpow</h2><p><img src=https://hackmd.io/_uploads/rkNys-hcgx.png loading=lazy alt=image></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span><span class=o>,</span> <span class=nn>secrets</span><span class=o>,</span> <span class=nn>json</span><span class=o>,</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- Utility functions ---</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sha256</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>b</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hexf</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>b</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>commit_vertex</span><span class=p>(</span><span class=n>v</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>color_label</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>nonce</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sha256</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;vertex:&#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;:&#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>color_label</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;:&#34;</span> <span class=o>+</span> <span class=n>nonce</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- Merkle tree helpers ---</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_merkle_tree</span><span class=p>(</span><span class=n>leaves_hex</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>leaves</span> <span class=o>=</span> <span class=p>[</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>h</span><span class=p>)</span> <span class=k>for</span> <span class=n>h</span> <span class=ow>in</span> <span class=n>leaves_hex</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>leaves</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>hexf</span><span class=p>(</span><span class=n>sha256</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&#34;</span><span class=p>)),</span> <span class=p>[[</span><span class=n>sha256</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&#34;</span><span class=p>)]]</span>
</span></span><span class=line><span class=cl>    <span class=n>levels</span> <span class=o>=</span> <span class=p>[</span><span class=n>leaves</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span> <span class=o>=</span> <span class=n>leaves</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>cur</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>nxt</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>cur</span><span class=p>),</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>left</span> <span class=o>=</span> <span class=n>cur</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>right</span> <span class=o>=</span> <span class=n>cur</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=k>if</span> <span class=n>i</span><span class=o>+</span><span class=mi>1</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>cur</span><span class=p>)</span> <span class=k>else</span> <span class=n>left</span>
</span></span><span class=line><span class=cl>            <span class=n>nxt</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sha256</span><span class=p>(</span><span class=n>left</span> <span class=o>+</span> <span class=n>right</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>levels</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>nxt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span> <span class=o>=</span> <span class=n>nxt</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hexf</span><span class=p>(</span><span class=n>levels</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]),</span> <span class=n>levels</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>merkle_proof_for_index</span><span class=p>(</span><span class=n>levels</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>level</span> <span class=ow>in</span> <span class=n>levels</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>idx</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sib_index</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>level</span><span class=p>)</span> <span class=k>else</span> <span class=n>idx</span>
</span></span><span class=line><span class=cl>            <span class=n>sibling</span> <span class=o>=</span> <span class=n>level</span><span class=p>[</span><span class=n>sib_index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>proof</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>hexf</span><span class=p>(</span><span class=n>sibling</span><span class=p>),</span> <span class=kc>False</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sib_index</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>sibling</span> <span class=o>=</span> <span class=n>level</span><span class=p>[</span><span class=n>sib_index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>proof</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>hexf</span><span class=p>(</span><span class=n>sibling</span><span class=p>),</span> <span class=kc>True</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>//=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>proof</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verify_merkle_proof</span><span class=p>(</span><span class=n>root_hex</span><span class=p>,</span> <span class=n>leaf_hex</span><span class=p>,</span> <span class=n>proof</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>leaf_hex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>sibling_hex</span><span class=p>,</span> <span class=n>sibling_is_left</span> <span class=ow>in</span> <span class=n>proof</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sibling</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>sibling_hex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>sibling_is_left</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>sibling</span> <span class=o>+</span> <span class=n>cur</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>cur</span> <span class=o>+</span> <span class=n>sibling</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hexf</span><span class=p>(</span><span class=n>cur</span><span class=p>)</span> <span class=o>==</span> <span class=n>root_hex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- Fiat-Shamir edge selection ---</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fiat_shamir_select_index</span><span class=p>(</span><span class=n>root_hex</span><span class=p>,</span> <span class=n>m</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>root_hex</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>(),</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span> <span class=o>%</span> <span class=n>m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- Configurable graph generator ---</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_graph</span><span class=p>(</span><span class=n>n_vertices</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> <span class=n>p_good</span><span class=o>=</span><span class=mf>0.75</span><span class=p>,</span> <span class=n>p_bad</span><span class=o>=</span><span class=mf>0.003</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>coloring</span> <span class=o>=</span> <span class=p>[</span><span class=n>secrets</span><span class=o>.</span><span class=n>randbelow</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_vertices</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>parts</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>:</span> <span class=p>[],</span> <span class=mi>1</span><span class=p>:</span> <span class=p>[],</span> <span class=mi>2</span><span class=p>:</span> <span class=p>[]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>v</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>coloring</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>parts</span><span class=p>[</span><span class=n>c</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>edges</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>c1</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>c2</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>c1</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>A</span><span class=p>,</span> <span class=n>B</span> <span class=o>=</span> <span class=n>parts</span><span class=p>[</span><span class=n>c1</span><span class=p>],</span> <span class=n>parts</span><span class=p>[</span><span class=n>c2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>u</span> <span class=ow>in</span> <span class=n>A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>               <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>B</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                   <span class=k>if</span> <span class=n>secrets</span><span class=o>.</span><span class=n>randbelow</span><span class=p>(</span><span class=mi>1_000_000</span><span class=p>)</span> <span class=o>/</span> <span class=mi>1_000_000</span> <span class=o>&lt;</span> <span class=n>p_good</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                       <span class=n>edges</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>))</span> <span class=c1># spice things up :)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>part</span> <span class=o>=</span> <span class=n>parts</span><span class=p>[</span><span class=n>c</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>part</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>part</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>secrets</span><span class=o>.</span><span class=n>randbelow</span><span class=p>(</span><span class=mi>1_000_000</span><span class=p>)</span> <span class=o>/</span> <span class=mi>1_000_000</span> <span class=o>&lt;</span> <span class=n>p_bad</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>edges</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>part</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>part</span><span class=p>[</span><span class=n>j</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>edges</span><span class=p>,</span> <span class=n>n_vertices</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- zkPoW prover ---</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>zkpow_prove</span><span class=p>(</span><span class=n>edges</span><span class=p>,</span> <span class=n>coloring</span><span class=p>,</span> <span class=n>n_vertices</span><span class=o>=</span><span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>verts</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>n_vertices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># permutation + colors</span>
</span></span><span class=line><span class=cl>    <span class=n>perm</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>secrets</span><span class=o>.</span><span class=n>SystemRandom</span><span class=p>()</span><span class=o>.</span><span class=n>shuffle</span><span class=p>(</span><span class=n>perm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>permuted</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span><span class=p>:</span> <span class=n>perm</span><span class=p>[</span><span class=n>coloring</span><span class=p>[</span><span class=n>v</span><span class=p>]]</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>verts</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>nonces</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span><span class=p>:</span> <span class=n>secrets</span><span class=o>.</span><span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>verts</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>leaves_hex</span> <span class=o>=</span> <span class=p>[</span><span class=n>hexf</span><span class=p>(</span><span class=n>commit_vertex</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>permuted</span><span class=p>[</span><span class=n>v</span><span class=p>],</span> <span class=n>nonces</span><span class=p>[</span><span class=n>v</span><span class=p>]))</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>verts</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>merkle_root</span><span class=p>,</span> <span class=n>levels</span> <span class=o>=</span> <span class=n>build_merkle_tree</span><span class=p>(</span><span class=n>leaves_hex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># pick single edge</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>fiat_shamir_select_index</span><span class=p>(</span><span class=n>merkle_root</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>edges</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>u</span><span class=p>,</span><span class=n>v</span> <span class=o>=</span> <span class=n>edges</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># prepare openings</span>
</span></span><span class=line><span class=cl>    <span class=n>openings</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>w</span> <span class=ow>in</span> <span class=p>(</span><span class=n>u</span><span class=p>,</span><span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>openings</span><span class=p>[</span><span class=n>w</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;color&#34;</span><span class=p>:</span> <span class=n>permuted</span><span class=p>[</span><span class=n>w</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;nonce&#34;</span><span class=p>:</span> <span class=n>hexf</span><span class=p>(</span><span class=n>nonces</span><span class=p>[</span><span class=n>w</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;merkle_proof&#34;</span><span class=p>:</span> <span class=n>merkle_proof_for_index</span><span class=p>(</span><span class=n>levels</span><span class=p>,</span> <span class=n>w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;merkle_root&#34;</span><span class=p>:</span> <span class=n>merkle_root</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;openings&#34;</span><span class=p>:</span> <span class=n>openings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- zkPoW verifier ---</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>zkpow_verify</span><span class=p>(</span><span class=n>proof</span><span class=p>,</span> <span class=n>edges</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>merkle_root</span> <span class=o>=</span> <span class=n>proof</span><span class=p>[</span><span class=s2>&#34;merkle_root&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>openings</span> <span class=o>=</span> <span class=n>proof</span><span class=p>[</span><span class=s2>&#34;openings&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># verify Merkle proofs</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>v_s</span><span class=p>,</span> <span class=n>opened</span> <span class=ow>in</span> <span class=n>openings</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>v_s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>leaf_hex</span> <span class=o>=</span> <span class=n>hexf</span><span class=p>(</span><span class=n>commit_vertex</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>opened</span><span class=p>[</span><span class=s2>&#34;color&#34;</span><span class=p>],</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>opened</span><span class=p>[</span><span class=s2>&#34;nonce&#34;</span><span class=p>])))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>verify_merkle_proof</span><span class=p>(</span><span class=n>merkle_root</span><span class=p>,</span> <span class=n>leaf_hex</span><span class=p>,</span> <span class=n>opened</span><span class=p>[</span><span class=s2>&#34;merkle_proof&#34;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Merkle proof failed for vertex </span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># recompute chosen edge</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>fiat_shamir_select_index</span><span class=p>(</span><span class=n>merkle_root</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>edges</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>u</span><span class=p>,</span><span class=n>v</span> <span class=o>=</span> <span class=nb>map</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>edges</span><span class=p>[</span><span class=n>idx</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>u</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>openings</span> <span class=ow>or</span> <span class=n>v</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>openings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Missing opening for endpoints of edge </span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>openings</span><span class=p>[</span><span class=n>u</span><span class=p>][</span><span class=s2>&#34;color&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>openings</span><span class=p>[</span><span class=n>v</span><span class=p>][</span><span class=s2>&#34;color&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Edge </span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2> endpoints same color -&gt; invalid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;==zk-proof-of-work: enabled==&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>50</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;==round </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>==&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>edges</span><span class=p>,</span> <span class=n>n_vertices</span> <span class=o>=</span> <span class=n>make_graph</span><span class=p>(</span><span class=n>i</span> <span class=o>*</span> <span class=mi>33</span> <span class=o>+</span> <span class=mi>10</span><span class=p>,</span> <span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s2>&#34;n&#34;</span><span class=p>:</span> <span class=n>n_vertices</span><span class=p>,</span> <span class=s2>&#34;edges&#34;</span><span class=p>:</span> <span class=n>edges</span><span class=p>}))</span>
</span></span><span class=line><span class=cl>        <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>proof</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=nb>input</span><span class=p>(</span><span class=s2>&#34;proof: &#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>end</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>end</span> <span class=o>-</span> <span class=n>start</span> <span class=o>&gt;</span> <span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;too slow!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ok</span> <span class=o>=</span> <span class=n>zkpow_verify</span><span class=p>(</span><span class=n>proof</span><span class=p>,</span> <span class=n>edges</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ok</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;verified!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;failed!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;flag.txt&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;flag:&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=phân-tích-và-lời-giải-1>Phân tích và lời giải</h3><p>Ở thử thách này, ta không cần phải tô 3 màu cho đồ thị. Hàm <code>verify</code> chỉ kiểm tra hai điểm cuối của một cạnh, và chỉ số cạnh đó là H(merkle_root) % m. Vì ta kiểm soát tất cả các nonce (vì là gốc Merkle) nên có thể thử nonce của một lá cho đến khi thử thách trỏ đến một cạnh có các điểm cuối có màu khác nhau theo bất kỳ màu ngẫu nhiên nào ta chọn. Điều này làm cho mỗi vòng trở nên đơn giản, không cần <code>backtracking</code> mà chỉ cần một vài lần băm.</p><p>Sau đây là các bước giải:</p><ol><li>Chọn một màu 3 ngẫu nhiên (bất kỳ màu nào cũng được).</li><li>Xây dựng cây Merkle một lần.</li><li>Liên tục điều chỉnh nonce của một lá và tính toán lại gốc Merkle theo từng bước (O(log n) mỗi lần thử).</li><li>Dừng ngay khi H(root) % m chọn một cạnh có màu khác nhau.</li><li>Gán hai đỉnh đó cho <code>openings</code></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># solution.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span><span class=o>,</span> <span class=nn>hashlib</span><span class=o>,</span> <span class=nn>secrets</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== Challenge-compatible helpers =====</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sha256</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>b</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>commit_vertex_bytes</span><span class=p>(</span><span class=n>v</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>color_label</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>nonce</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># EXACT match to the server&#39;s commit function (but returns raw bytes)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sha256</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;vertex:&#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;:&#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>color_label</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;:&#34;</span> <span class=o>+</span> <span class=n>nonce</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fiat_shamir_select_index</span><span class=p>(</span><span class=n>root_hex</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>m</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>root_hex</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>(),</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span> <span class=o>%</span> <span class=n>m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== Merkle (bytes throughout, then hex only when serializing the proof) =====</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_merkle_tree_bytes</span><span class=p>(</span><span class=n>leaves</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    leaves: list[bytes]
</span></span></span><span class=line><span class=cl><span class=s2>    returns: (root_bytes, levels)
</span></span></span><span class=line><span class=cl><span class=s2>      levels[0] = leaves (bytes)
</span></span></span><span class=line><span class=cl><span class=s2>      levels[h] = list of bytes at height h
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>leaves</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>z</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>z</span><span class=p>,</span> <span class=p>[[</span><span class=n>z</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=n>levels</span> <span class=o>=</span> <span class=p>[</span><span class=nb>list</span><span class=p>(</span><span class=n>leaves</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span> <span class=o>=</span> <span class=n>levels</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>cur</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>nxt</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>cur</span><span class=p>),</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>left</span> <span class=o>=</span> <span class=n>cur</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>right</span> <span class=o>=</span> <span class=n>cur</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=k>if</span> <span class=n>i</span><span class=o>+</span><span class=mi>1</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>cur</span><span class=p>)</span> <span class=k>else</span> <span class=n>left</span>
</span></span><span class=line><span class=cl>            <span class=n>nxt</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sha256</span><span class=p>(</span><span class=n>left</span> <span class=o>+</span> <span class=n>right</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>levels</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>nxt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span> <span class=o>=</span> <span class=n>nxt</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>levels</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>levels</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_leaf_inplace</span><span class=p>(</span><span class=n>levels</span><span class=p>,</span> <span class=n>index</span><span class=p>,</span> <span class=n>new_leaf</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Update levels in place after changing one leaf.
</span></span></span><span class=line><span class=cl><span class=s2>    O(log n) hashes up to the root, honoring the &#39;duplicate last&#39; rule.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>levels</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>index</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_leaf</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>h</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>levels</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>level</span> <span class=o>=</span> <span class=n>levels</span><span class=p>[</span><span class=n>h</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># figure siblings and parent</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>idx</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>right_idx</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>level</span><span class=p>)</span> <span class=k>else</span> <span class=n>idx</span>
</span></span><span class=line><span class=cl>            <span class=n>left</span> <span class=o>=</span> <span class=n>level</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>right</span> <span class=o>=</span> <span class=n>level</span><span class=p>[</span><span class=n>right_idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>parent</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>left</span> <span class=o>+</span> <span class=n>right</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>left_idx</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>left</span> <span class=o>=</span> <span class=n>level</span><span class=p>[</span><span class=n>left_idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>right</span> <span class=o>=</span> <span class=n>level</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>parent</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>left</span> <span class=o>+</span> <span class=n>right</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># write parent</span>
</span></span><span class=line><span class=cl>        <span class=n>levels</span><span class=p>[</span><span class=n>h</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>idx</span> <span class=o>//</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>parent</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>//=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>merkle_proof_for_index</span><span class=p>(</span><span class=n>levels</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Returns proof as list of (sibling_hex, sibling_is_left_bool),
</span></span></span><span class=line><span class=cl><span class=s2>    exactly like the challenge expects.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>index</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>level</span> <span class=ow>in</span> <span class=n>levels</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>idx</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sib_index</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>level</span><span class=p>)</span> <span class=k>else</span> <span class=n>idx</span>
</span></span><span class=line><span class=cl>            <span class=n>sibling</span> <span class=o>=</span> <span class=n>level</span><span class=p>[</span><span class=n>sib_index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>proof</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>sibling</span><span class=o>.</span><span class=n>hex</span><span class=p>(),</span> <span class=kc>False</span><span class=p>))</span>  <span class=c1># sibling on the right</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sib_index</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>sibling</span> <span class=o>=</span> <span class=n>level</span><span class=p>[</span><span class=n>sib_index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>proof</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>sibling</span><span class=o>.</span><span class=n>hex</span><span class=p>(),</span> <span class=kc>True</span><span class=p>))</span>   <span class=c1># sibling on the left</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>//=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>proof</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== Core: nonce grinding (no coloring solve needed) =====</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_and_print_proof</span><span class=p>(</span><span class=n>graph_line</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>graph_line</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=n>obj</span><span class=p>[</span><span class=s2>&#34;n&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>edges</span> <span class=o>=</span> <span class=n>obj</span><span class=p>[</span><span class=s2>&#34;edges&#34;</span><span class=p>]</span>  <span class=c1># list of [u, v]</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>edges</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 1) Any random 3-coloring works (we only need one good edge per round)</span>
</span></span><span class=line><span class=cl>    <span class=n>rng</span> <span class=o>=</span> <span class=n>secrets</span><span class=o>.</span><span class=n>SystemRandom</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>colors</span> <span class=o>=</span> <span class=p>[</span><span class=n>rng</span><span class=o>.</span><span class=n>randrange</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2) Random nonces for all vertices; build initial tree once</span>
</span></span><span class=line><span class=cl>    <span class=n>nonces</span> <span class=o>=</span> <span class=p>[</span><span class=n>secrets</span><span class=o>.</span><span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>leaves</span> <span class=o>=</span> <span class=p>[</span><span class=n>commit_vertex_bytes</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>colors</span><span class=p>[</span><span class=n>v</span><span class=p>],</span> <span class=n>nonces</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>root_bytes</span><span class=p>,</span> <span class=n>levels</span> <span class=o>=</span> <span class=n>build_merkle_tree_bytes</span><span class=p>(</span><span class=n>leaves</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3) Grind a SINGLE leaf&#39;s nonce until H(root) % m hits a &#34;good&#34; edge</span>
</span></span><span class=line><span class=cl>    <span class=n>pivot</span> <span class=o>=</span> <span class=mi>0</span>  <span class=c1># any index works</span>
</span></span><span class=line><span class=cl>    <span class=c1># Keep a small safety cap; expected tries ~ 1.5 because ~2/3 edges are &#34;good&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>max_tries</span> <span class=o>=</span> <span class=mi>4096</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_tries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># new nonce for pivot leaf</span>
</span></span><span class=line><span class=cl>        <span class=n>nonces</span><span class=p>[</span><span class=n>pivot</span><span class=p>]</span> <span class=o>=</span> <span class=n>secrets</span><span class=o>.</span><span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>new_leaf</span> <span class=o>=</span> <span class=n>commit_vertex_bytes</span><span class=p>(</span><span class=n>pivot</span><span class=p>,</span> <span class=n>colors</span><span class=p>[</span><span class=n>pivot</span><span class=p>],</span> <span class=n>nonces</span><span class=p>[</span><span class=n>pivot</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>update_leaf_inplace</span><span class=p>(</span><span class=n>levels</span><span class=p>,</span> <span class=n>pivot</span><span class=p>,</span> <span class=n>new_leaf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>root_hex</span> <span class=o>=</span> <span class=n>levels</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>=</span> <span class=n>fiat_shamir_select_index</span><span class=p>(</span><span class=n>root_hex</span><span class=p>,</span> <span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span><span class=p>,</span> <span class=n>v</span> <span class=o>=</span> <span class=n>edges</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>colors</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>!=</span> <span class=n>colors</span><span class=p>[</span><span class=n>v</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 4) Prepare openings for the challenged edge only</span>
</span></span><span class=line><span class=cl>            <span class=n>openings</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>w</span> <span class=ow>in</span> <span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>openings</span><span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>w</span><span class=p>)]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;color&#34;</span><span class=p>:</span> <span class=n>colors</span><span class=p>[</span><span class=n>w</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;nonce&#34;</span><span class=p>:</span> <span class=n>nonces</span><span class=p>[</span><span class=n>w</span><span class=p>]</span><span class=o>.</span><span class=n>hex</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;merkle_proof&#34;</span><span class=p>:</span> <span class=n>merkle_proof_for_index</span><span class=p>(</span><span class=n>levels</span><span class=p>,</span> <span class=n>w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>proof</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;merkle_root&#34;</span><span class=p>:</span> <span class=n>root_hex</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;openings&#34;</span><span class=p>:</span> <span class=n>openings</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># In practice we should never get here; fallback (recolor &amp; retry once)</span>
</span></span><span class=line><span class=cl>    <span class=n>colors</span> <span class=o>=</span> <span class=p>[</span><span class=n>rng</span><span class=o>.</span><span class=n>randrange</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>nonces</span> <span class=o>=</span> <span class=p>[</span><span class=n>secrets</span><span class=o>.</span><span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>leaves</span> <span class=o>=</span> <span class=p>[</span><span class=n>commit_vertex_bytes</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>colors</span><span class=p>[</span><span class=n>v</span><span class=p>],</span> <span class=n>nonces</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>root_bytes</span><span class=p>,</span> <span class=n>levels</span> <span class=o>=</span> <span class=n>build_merkle_tree_bytes</span><span class=p>(</span><span class=n>leaves</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_tries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>nonces</span><span class=p>[</span><span class=n>pivot</span><span class=p>]</span> <span class=o>=</span> <span class=n>secrets</span><span class=o>.</span><span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>new_leaf</span> <span class=o>=</span> <span class=n>commit_vertex_bytes</span><span class=p>(</span><span class=n>pivot</span><span class=p>,</span> <span class=n>colors</span><span class=p>[</span><span class=n>pivot</span><span class=p>],</span> <span class=n>nonces</span><span class=p>[</span><span class=n>pivot</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>update_leaf_inplace</span><span class=p>(</span><span class=n>levels</span><span class=p>,</span> <span class=n>pivot</span><span class=p>,</span> <span class=n>new_leaf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>root_hex</span> <span class=o>=</span> <span class=n>levels</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>=</span> <span class=n>fiat_shamir_select_index</span><span class=p>(</span><span class=n>root_hex</span><span class=p>,</span> <span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span><span class=p>,</span> <span class=n>v</span> <span class=o>=</span> <span class=n>edges</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>colors</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>!=</span> <span class=n>colors</span><span class=p>[</span><span class=n>v</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>openings</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>w</span> <span class=ow>in</span> <span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>openings</span><span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>w</span><span class=p>)]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;color&#34;</span><span class=p>:</span> <span class=n>colors</span><span class=p>[</span><span class=n>w</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;nonce&#34;</span><span class=p>:</span> <span class=n>nonces</span><span class=p>[</span><span class=n>w</span><span class=p>]</span><span class=o>.</span><span class=n>hex</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;merkle_proof&#34;</span><span class=p>:</span> <span class=n>merkle_proof_for_index</span><span class=p>(</span><span class=n>levels</span><span class=p>,</span> <span class=n>w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>proof</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;merkle_root&#34;</span><span class=p>:</span> <span class=n>root_hex</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;openings&#34;</span><span class=p>:</span> <span class=n>openings</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># If still unlucky, bail so you can inspect</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;Grinding failed unexpectedly&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== Runner =====</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s2>&#34;error&#34;</span>  <span class=c1># keep pwntools quiet &amp; fast</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># io = process([&#39;python3&#39;, &#39;zkpow.py&#39;])</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;zkpow.chal.imaginaryctf.org&#34;</span><span class=p>,</span> <span class=mi>1337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># banner</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>50</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>          <span class=c1># &#34;==round i==&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>graph_line</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>  <span class=c1># JSON line with n &amp; edges</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>proof</span> <span class=o>=</span> <span class=n>build_and_print_proof</span><span class=p>(</span><span class=n>graph_line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>proof</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># print progress without slowing down</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Round </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>res</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># flag</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><pre><code>Flag: ictf{zero_knowledge_proof_more_like_i_have_zero_knowledge_of_how_to_prove_this}
</code></pre><h2 id=scalar-division>scalar-division</h2><p><img src=https://hackmd.io/_uploads/SkB5UpJigx.png loading=lazy alt=image></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># chall.sage</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=p>((</span><span class=n>E</span><span class=o>:=</span><span class=n>EllipticCurve</span><span class=p>(</span><span class=n>GF</span><span class=p>(</span><span class=mh>0xbde3c425157a83cbe69cee172d27e2ef9c1bd754ff052d4e7e6a26074efcea673eab9438dc45e0786c4ea54a89f9079ddb21</span><span class=p>),[</span><span class=mi>5</span><span class=p>,</span><span class=mi>7</span><span class=p>]))</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>factor</span><span class=p>(</span><span class=n>limit</span><span class=o>=</span><span class=mi>2</span><span class=o>**</span><span class=mi>10</span><span class=p>)[</span><span class=mi>3</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=n>E</span><span class=o>.</span><span class=n>lift_x</span><span class=p>(</span><span class=n>ZZ</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>((</span><span class=n>flag</span><span class=o>:=</span><span class=nb>input</span><span class=p>(</span><span class=s1>&#39;ictf{&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>encode</span><span class=p>()))))</span><span class=o>.</span><span class=n>x</span><span class=p>()</span> <span class=o>==</span> <span class=mh>0x686be42f9c3f431296a928c288145a847364bb259c9f5738270d48a7fba035377cc23b27f69d6ae0fad76d745fab25d504d5</span> <span class=ow>and</span> <span class=ow>not</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\033</span><span class=s1>[53C</span><span class=se>\033</span><span class=s1>[1A}&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=phân-tích-và-lời-giải-2>Phân tích và lời giải</h3><p><code>assert</code> kiểm tra: nếu điểm có hoành độ là <code>Q.xy()[0]</code> lift và nhân với k thì nó phải bằng target_x. Tức là <code>assert(k * lift_x(x_Q)).x() == target_x</code>.</p><p>Ý tưởng chính:
Nguyên lý dùng ở đây là: nếu thứ tự nhóm điểm của elliptic curve là n và n có một nhân tử là k, thì phép nhân $[k]:P\rightarrow kP$ không phải là đơn ánh mà nó tồn tại một nhân tử (kernel) thứ bậc k.</p><p>Source
If n is a positive integer, we denote by $E(\mathbb{Q})[n]$ the subgroup of rational points of order dividing n, which is the kernel of the multiplication map from E to itself.
<a class=link href=https://johncremona.github.io/book/fulltext/chapter3.pdf target=_blank rel=noopener>https://johncremona.github.io/book/fulltext/chapter3.pdf</a></p><p>Bằng cách dựng $Q = k^{-1} * R$ và sau đó cộng mọi phần tử thuộc kernel (jS), ta thu được nhiều $x_Q$ sao cho khi nhân k vẫn trả về R (tức là target_x).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># solution.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sage.all</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>long_to_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=mh>0xbde3c425157a83cbe69cee172d27e2ef9c1bd754ff052d4e7e6a26074efcea673eab9438dc45e0786c4ea54a89f9079ddb21</span>
</span></span><span class=line><span class=cl><span class=n>E</span> <span class=o>=</span> <span class=n>EllipticCurve</span><span class=p>(</span><span class=n>GF</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=p>[</span><span class=mi>5</span><span class=p>,</span><span class=mi>7</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=n>E</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>fac</span> <span class=o>=</span> <span class=n>n</span><span class=o>.</span><span class=n>factor</span><span class=p>(</span><span class=n>limit</span><span class=o>=</span><span class=mi>2</span><span class=o>**</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>k</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>fac</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>target_x</span> <span class=o>=</span> <span class=mh>0x686be42f9c3f431296a928c288145a847364bb259c9f5738270d48a7fba035377cc23b27f69d6ae0fad76d745fab25d504d5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>m</span> <span class=o>=</span> <span class=n>n</span> <span class=o>//</span> <span class=n>k</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>R</span> <span class=o>=</span> <span class=n>E</span><span class=o>.</span><span class=n>lift_x</span><span class=p>(</span><span class=n>ZZ</span><span class=p>(</span><span class=n>target_x</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>k_inv_mod_m</span> <span class=o>=</span> <span class=n>inverse_mod</span><span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Q</span> <span class=o>=</span> <span class=n>k_inv_mod_m</span> <span class=o>*</span> <span class=n>R</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=p>((</span><span class=n>E</span><span class=o>:=</span><span class=n>EllipticCurve</span><span class=p>(</span><span class=n>GF</span><span class=p>(</span><span class=mh>0xbde3c425157a83cbe69cee172d27e2ef9c1bd754ff052d4e7e6a26074efcea673eab9438dc45e0786c4ea54a89f9079ddb21</span><span class=p>),[</span><span class=mi>5</span><span class=p>,</span><span class=mi>7</span><span class=p>]))</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>factor</span><span class=p>(</span><span class=n>limit</span><span class=o>=</span><span class=mi>2</span><span class=o>**</span><span class=mi>10</span><span class=p>)[</span><span class=mi>3</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=n>E</span><span class=o>.</span><span class=n>lift_x</span><span class=p>(</span><span class=n>ZZ</span><span class=p>(</span><span class=n>Q</span><span class=o>.</span><span class=n>xy</span><span class=p>()[</span><span class=mi>0</span><span class=p>])))</span><span class=o>.</span><span class=n>x</span><span class=p>()</span> <span class=o>==</span> <span class=mh>0x686be42f9c3f431296a928c288145a847364bb259c9f5738270d48a7fba035377cc23b27f69d6ae0fad76d745fab25d504d5</span> <span class=ow>and</span> <span class=ow>not</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\033</span><span class=s1>[53C</span><span class=se>\033</span><span class=s1>[1A}&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># S được chọn sao cho nhóm con sinh bởi S có kích thước k (tức là kS = O)</span>
</span></span><span class=line><span class=cl><span class=n>S</span> <span class=o>=</span> <span class=n>E</span><span class=o>.</span><span class=n>lift_x</span><span class=p>(</span><span class=n>ZZ</span><span class=p>(</span><span class=mi>1908615609373310359393680708495309867245478461545179513106385994207950225114719305735749421285909081171302218073610177595</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>lst</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>Pj</span> <span class=o>=</span> <span class=n>Q</span> <span class=o>+</span> <span class=n>j</span> <span class=o>*</span> <span class=n>S</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>Pj</span><span class=o>.</span><span class=n>xy</span><span class=p>()[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=n>long_to_bytes</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;ignore&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>all</span><span class=p>(</span><span class=n>ch</span> <span class=ow>in</span> <span class=n>string</span><span class=o>.</span><span class=n>printable</span> <span class=k>for</span> <span class=n>ch</span> <span class=ow>in</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><pre><code>Flag: ictf{mayb3_d0nt_m4ke_th3_sca1ar_a_f4ctor_0f_the_ord3r}
</code></pre><h2 id=redacted>redacted</h2><p><img src=https://hackmd.io/_uploads/SkhUIKHolx.png loading=lazy alt=image>
<img src=https://hackmd.io/_uploads/Syuj8tHixg.png loading=lazy alt=image></p><h3 id=phân-tích-và-lời-giải-3>Phân tích và lời giải</h3><p>Theo lẽ thường, qua phép XOR thì 2 giá trị như nhau sẽ cho ra giá trị 0. Tuy nhiên, ở đây cùng 1 giá trị nhưng lại cho ra 1 output có giá trị khác 0&mldr; Là bởi phần key của phép XOR không phải dạng ASCII mà là dạng hex nên nó sẽ chỉ lấy những giá trị trong hệ thập lục phân.</p><p>Ở đây, phần key của CyberChef dạng hex được lấy theo kiểu sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>cyberchef_hexparse</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>ch</span> <span class=ow>in</span> <span class=n>a</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ch</span> <span class=ow>in</span> <span class=n>string</span><span class=o>.</span><span class=n>hexdigits</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span> <span class=o>+=</span> <span class=n>ch</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39; &#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>h</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>                <span class=n>h</span> <span class=o>+=</span> <span class=s1>&#39; &#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span> <span class=o>+=</span> <span class=s1>&#39; &#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>([</span><span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>h</span><span class=o>.</span><span class=n>split</span><span class=p>()])</span>
</span></span></code></pre></td></tr></table></div></div><p>Với bài này thì mình thử brute-force và mong rằng độ dài key là nhỏ :3</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># solution.py</span>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/python</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cyberchef_hexparse</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>ch</span> <span class=ow>in</span> <span class=n>a</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ch</span> <span class=ow>in</span> <span class=n>string</span><span class=o>.</span><span class=n>hexdigits</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span> <span class=o>+=</span> <span class=n>ch</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39; &#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>h</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>                <span class=n>h</span> <span class=o>+=</span> <span class=s1>&#39; &#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span> <span class=o>+=</span> <span class=s1>&#39; &#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>([</span><span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>h</span><span class=o>.</span><span class=n>split</span><span class=p>()])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cyberchef_xor</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=n>key</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>a</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>OUTPUT</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s1>&#39;656cce6bc175617e5366c952d86c6a536e6ede52df636d7e757fce64d56373&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>FLAG_PREFIX</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;ictf{&#39;</span>
</span></span><span class=line><span class=cl><span class=n>key_prefix</span> <span class=o>=</span> <span class=n>cyberchef_xor</span><span class=p>(</span><span class=n>FLAG_PREFIX</span><span class=p>,</span> <span class=n>OUTPUT</span><span class=p>[:</span><span class=nb>len</span><span class=p>(</span><span class=n>FLAG_PREFIX</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>attempt_length</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key_prefix</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>OUTPUT</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>attempt_length</span> <span class=si>= }</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>256</span> <span class=o>**</span> <span class=p>(</span><span class=n>attempt_length</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>key_prefix</span><span class=p>))):</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=n>key_prefix</span> <span class=o>+</span> <span class=n>attempt</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=n>attempt_length</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>key_prefix</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>flag</span> <span class=o>=</span> <span class=n>cyberchef_xor</span><span class=p>(</span><span class=n>OUTPUT</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>flag</span><span class=o>.</span><span class=n>isascii</span><span class=p>()</span> <span class=ow>and</span> <span class=n>cyberchef_hexparse</span><span class=p>(</span><span class=n>flag</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span> <span class=o>==</span> <span class=n>key</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Found: </span><span class=si>{</span><span class=n>flag</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><pre><code>Flag: ictf{xor_is_bad_bad_encryption}
</code></pre><h2 id=leaky-rsa-revenge>leaky-rsa-revenge</h2><p><img src=https://hackmd.io/_uploads/HJ8iRtLjge.png loading=lazy alt=image></p><p><code>chall.py</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/local/bin/python3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>getPrime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.Padding</span> <span class=kn>import</span> <span class=n>pad</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>secrets</span> <span class=kn>import</span> <span class=n>randbelow</span><span class=p>,</span> <span class=n>token_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>sha256</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;flag.txt&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>getPrime</span><span class=p>(</span><span class=mi>512</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>getPrime</span><span class=p>(</span><span class=mi>512</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=n>p</span> <span class=o>*</span> <span class=n>q</span>
</span></span><span class=line><span class=cl><span class=n>e</span> <span class=o>=</span> <span class=mi>65537</span>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=n>p</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>q</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key_m</span> <span class=o>=</span> <span class=n>randbelow</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key_c</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>key_m</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>key_m</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ct</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>IV</span><span class=o>=</span><span class=n>iv</span><span class=p>)</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>pad</span><span class=p>(</span><span class=n>flag</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span> <span class=mi>16</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;n&#39;</span><span class=p>:</span> <span class=n>n</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=n>key_c</span><span class=p>,</span> <span class=s1>&#39;iv&#39;</span><span class=p>:</span> <span class=n>iv</span><span class=o>.</span><span class=n>hex</span><span class=p>(),</span> <span class=s1>&#39;ct&#39;</span><span class=p>:</span> <span class=n>ct</span><span class=o>.</span><span class=n>hex</span><span class=p>()}))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_bit</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=n>k</span><span class=p>)</span> <span class=o>%</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1024</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>randbelow</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;idx&#39;</span><span class=p>:</span> <span class=n>idx</span><span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=nb>input</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;c&#39;</span><span class=p>]</span> <span class=o>%</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>c</span> <span class=o>!=</span> <span class=n>key_c</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=n>get_bit</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>,</span> <span class=ne>TypeError</span><span class=p>,</span> <span class=ne>KeyError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>,</span> <span class=ne>AssertionError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=n>b</span><span class=p>}))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=phân-tích>Phân tích</h3><p>Thử thách này đã sửa lỗi của bài trước bằng cách bỏ phần leak <code>key_m</code> ở cuối.
Ta được cung cấp các tham số như sau:</p><ul><li><code>n</code>: tích của hai số nguyên tố 512 bit <code>p</code> và <code>q</code></li><li><code>e</code>: Khóa công khai, có giá trị bằng <code>65537</code></li><li><code>key_c</code>: là khóa <code>key_m</code> sau khi được mã hóa RSA với <code>n</code> và <code>e</code></li><li><code>iv</code>: Là init vector khi mã hóa AES <code>flag</code> bằng khóa là <code>sha256</code> của <code>key_m</code></li><li><code>ct</code>: Là mã hóa AES của <code>flag</code>.</li></ul><p>Đề bài cho phép ta gửi lần lượt 1024 số và nhận một trong các bit thứ 0-3 của giải mã RSA của các số đó:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1024</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>randbelow</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;idx&#39;</span><span class=p>:</span> <span class=n>idx</span><span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=nb>input</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;c&#39;</span><span class=p>]</span> <span class=o>%</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>c</span> <span class=o>!=</span> <span class=n>key_c</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=n>get_bit</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>,</span> <span class=ne>TypeError</span><span class=p>,</span> <span class=ne>KeyError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>,</span> <span class=ne>AssertionError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=n>b</span><span class=p>}))</span>
</span></span></code></pre></td></tr></table></div></div><p>=> Ta phải khôi phục lại khóa <code>key_m</code> (từ đây gọi tắt là <code>m</code>) để lấy flag.</p><h3 id=hướng-giải>Hướng giải</h3><p>Bài này tương tự như tấn công LSB oracle.</p><p><a class=link href=https://crypto.stackexchange.com/questions/11053/rsa-least-significant-bit-oracle-attack target=_blank rel=noopener>https://crypto.stackexchange.com/questions/11053/rsa-least-significant-bit-oracle-attack</a></p><p>Để tấn công, ta gửi $(2^{e \times i} \mod n)*c$ để giải mã và nhận $(((2^i\mod n) \times m) \mod n) \mod 2$.
Để ý rằng $((2^{i+1}\mod n) \times m) \mod n$ bằng $((2^i\mod n) \times m) \mod n$ và trừ cho $0$ hoặc $n$, tùy thuộc vào việc $((2^i\mod n) \times m) \mod n$ lớn hơn hay nhỏ hơn $\dfrac{n}{2}$.
Vì vậy, việc so sánh $(((2^i\mod n) \times m) \mod n) \mod 2$ và $(((2^{i+1}\mod n) \times m) \mod n) \mod 2$ cho ta MSB của $(2^i\mod n) \times m$. Ở đây, ta nhận được ngẫu nhiên một trong bốn bit thấp.</p><p>Đầu tiên, ta thử các trường hợp cho đến khi ta nhận được $n\equiv -1 \mod 16$.
Bây giờ, giả sử ta nhận được LSB thứ ba (chỉ số 2, vị trí thứ tư). Ta có thể gửi $(2^{e \times (i+3)} \mod n)*c$ và nhận lại $((8\times (2^i\mod n) \times m) \mod n)$ & 4.</p><p>Như vậy,</p>$$((8\times (2^i\mod n) \times m) \mod n) & 4 =int((((8\times (2^i\mod n) \times m) \mod n)\mod 8) \ge 4)$$<p>và giá trị $((8\times (2^i\mod n) \times m) \mod n)\mod 8$ là bit đúng sai của đẳng thức</p>$$0-n\times \lfloor\dfrac{(8\times (2^i\mod n) \times m)}{n}\rfloor\mod 8 =\lfloor\dfrac{(8\times (2^i\mod n) \times m)}{n}\rfloor\mod 8$$<p>Giá trị này cho chúng ta biết $(2^i \mod n) \times m$ nằm trong khoảng nào trong số các khoảng $[0, n/8), &mldr;, [7*n/8, n)$, nhưng chúng ta chỉ nhận được MSB của nó (từ $\ge 4$ hoặc & 4), vì vậy về cơ bản chúng ta chỉ nhận được một MSG của $(2^i \mod n) \times m$.
Lặp lại điều này sẽ cho phép chúng ta thu được toàn bộ <code>m</code>.</p><p>Về bản chất, phương pháp này là binary-search trên phần fractional m/n: mỗi bit thu được sẽ cho ta cắt đôi khoảng hiện tại (giống LSB-oracle). Dùng việc hỏi “bit của octant” là một biến thể nhưng về lượng thông tin mỗi truy vấn vẫn ~1 bit, do đó độ phức tạp tương đương LSB-oracle cơ bản.</p><p>Sau đây là phần code giải:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># get_key_m.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fractions</span> <span class=kn>import</span> <span class=n>Fraction</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># context.log_level = &#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># target = process([&#34;python3&#34;, &#34;chall.py&#34;])</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;leaky-rsa-revenge.chal.imaginaryctf.org&#39;</span><span class=p>,</span> <span class=mi>1337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;c&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;n&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;iv&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ct</span> <span class=o>=</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;ct&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span> <span class=o>=</span> <span class=mi>65537</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>target</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ct</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>target</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ct</span> <span class=o>=</span> <span class=n>get_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=n>n</span> <span class=o>&amp;</span> <span class=mh>0xf</span> <span class=o>!=</span> <span class=mh>0xf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ct</span> <span class=o>=</span> <span class=n>get_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>open</span><span class=p>(</span><span class=s2>&#34;ct.hex&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;iv&#39;</span><span class=p>:</span> <span class=n>iv</span><span class=p>,</span> <span class=s1>&#39;ct&#39;</span><span class=p>:</span> <span class=n>ct</span><span class=p>}))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;n:&#34;</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;c:&#34;</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>low</span><span class=p>,</span> <span class=n>high</span> <span class=o>=</span> <span class=n>Fraction</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=n>Fraction</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=o>.</span><span class=n>bit_length</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>target</span><span class=o>.</span><span class=n>recvline</span><span class=p>())[</span><span class=s1>&#39;idx&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;----------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Round </span><span class=si>{</span><span class=n>_</span><span class=si>}</span><span class=s2>, idx: </span><span class=si>{</span><span class=n>x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c_i</span> <span class=o>=</span> <span class=n>c</span> <span class=o>*</span> <span class=nb>pow</span><span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=p>(</span><span class=n>_</span><span class=o>+</span><span class=mi>1</span><span class=o>+</span><span class=n>x</span><span class=p>),</span> <span class=n>e</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span><span class=o>%</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=n>c_i</span><span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=n>parity</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>target</span><span class=o>.</span><span class=n>recvline</span><span class=p>())[</span><span class=s1>&#39;b&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;parity:&#34;</span><span class=p>,</span> <span class=n>parity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mid</span> <span class=o>=</span> <span class=p>(</span><span class=n>low</span> <span class=o>+</span> <span class=n>high</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>parity</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>high</span> <span class=o>=</span> <span class=n>mid</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>low</span> <span class=o>=</span> <span class=n>mid</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>high</span> <span class=o>-</span> <span class=n>low</span> <span class=o>&lt;=</span> <span class=n>Fraction</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;low: </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>low</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;high: </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>high</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;high - low: </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>high</span> <span class=o>-</span> <span class=n>low</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>high</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># get_flag.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.Padding</span> <span class=kn>import</span> <span class=n>unpad</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>sha256</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;ct.hex&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>iv</span><span class=p>,</span> <span class=n>ct</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;iv&#34;</span><span class=p>]),</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;ct&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># copy key_m from the result</span>
</span></span><span class=line><span class=cl><span class=n>key_m</span> <span class=o>=</span> <span class=mi>66913879129427921532141095805213088350786068884711371183610467808888726432628555235077071240182816868700010352314530781554928879532699339797452869208244793928847297090122325104212375055788476001149144065203543329623887717342649312948304461426083404294042817825376050063313290113639594521177002093126711190702</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>key_m</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=n>unpad</span><span class=p>(</span><span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>IV</span><span class=o>=</span><span class=n>iv</span><span class=p>)</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>ct</span><span class=p>),</span> <span class=mi>16</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><pre><code>Flag: ictf{p13cin9_7h3_b1t5_t0g37her_7d092f5d43ebbf6fa60fba8c9e9ac4466daba9a71d04def7e5bf09bcce5649c8}
</code></pre><h2 id=clcg>clcg</h2><p><img src=https://hackmd.io/_uploads/HkHj9cLsgl.png loading=lazy alt=image></p><p><code>chall.py</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>getPrime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.Padding</span> <span class=kn>import</span> <span class=n>pad</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>secrets</span> <span class=kn>import</span> <span class=n>randbelow</span><span class=p>,</span> <span class=n>token_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;flag.txt&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CLCG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>length</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>p</span> <span class=o>=</span> <span class=n>getPrime</span><span class=p>(</span><span class=mi>256</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>A</span> <span class=o>=</span> <span class=p>[</span><span class=n>randbelow</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>p</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>length</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>C</span> <span class=o>=</span> <span class=p>[</span><span class=n>randbelow</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>p</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>length</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>X</span> <span class=o>=</span> <span class=p>[</span><span class=n>randbelow</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>p</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>length</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rand</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>X</span> <span class=o>=</span> <span class=p>[(</span><span class=n>a</span> <span class=o>*</span> <span class=n>x</span> <span class=o>+</span> <span class=n>c</span><span class=p>)</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>p</span> <span class=k>for</span> <span class=n>a</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>A</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>X</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>C</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>int</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>((</span><span class=nb>sum</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>X</span><span class=p>)</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>p</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>192</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NUM_HINTS</span> <span class=o>=</span> <span class=mi>36</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>clcg</span> <span class=o>=</span> <span class=n>CLCG</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=p>[</span><span class=s1>&#39;p&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>clcg</span><span class=o>.</span><span class=n>p</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=p>[</span><span class=s1>&#39;A&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>clcg</span><span class=o>.</span><span class=n>A</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=p>[</span><span class=s1>&#39;hints&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>clcg</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NUM_HINTS</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>clcg</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span> <span class=o>+</span> <span class=n>clcg</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=o>=</span><span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=p>[</span><span class=s1>&#39;iv&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>iv</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=p>[</span><span class=s1>&#39;ct&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>pad</span><span class=p>(</span><span class=n>flag</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span> <span class=mi>16</span><span class=p>))</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=phân-tích-đề-bài>Phân tích đề bài</h3><ul><li>p, A, C, X lần luợt là số nguyên tố 256 bit và các list gồm 1 độ dài nhất định (theo đề là 8) các giá trị ngẫu nhiên bé hơn p.</li><li>Hàm <code>rand()</code> cho đầu ra là top 64 bit đầu của tổng S là 8 giá trị LCG không phụ thuộc modulo p của các cặp (A, X, C) tương ứng và gán X mới lần lượt là 8 giá trị LCG này. $$X^{(i)}_{t+1}\equiv a_i\times X^{(i)}_t+c_i\mod p,i=[1, 8]$$ $$S =\displaystyle \sum_{i=1}^8 X_t^{(i)}\mod p$$</li><li>Lấy hàm <code>rand()</code> 36 lần rồi lấy 2 lần tiếp theo làm key cho chế độ mã hóa AES mode CBC với iv là ngẫu nhiên và plaintext là flag.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>data</span><span class=p>[</span><span class=s1>&#39;hints&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>clcg</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>36</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>clcg</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span> <span class=o>+</span> <span class=n>clcg</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=n>token_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=o>=</span><span class=n>iv</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=hướng-giải-1>Hướng giải</h3><p>Hint from admin</p><p>Note that if <code>x1 = a*x0 + c</code> then <code>x1 + c/(a-1) = a*x0 + ac/(a-1) = a(x0 + c/(a-1))</code> so <code>xi = C*a**i - c/(a-1)</code>. If we add up 8 LCGs, it will be of the form <code>sum(Cj*aj**i for j) - D</code>, and taking the partial differences gets rid of <code>D</code>. We now note that this satisfies the linear recurrence whose characteristic polynomial is <code>prod(x - aj for j)</code>. We use this recurrence to build a lattice that will be <code>0</code> mod <code>p</code> when multiplied by the vector of true differences between state sums.</p><h4 id=khai-thác-từ-lcg-cho-trước>Khai thác từ LCG cho trước</h4><p>Từ phép biến đổi affine LCG ta sẽ thử tạo chuỗi cấp số và trình bày công thức.
Giả sử, tồn tại $k$ sao cho:</p>$$X^{(i)}_{t+1} + k\equiv a_i\times (X^{(i)}_t+k)\mod p,i=[1, 8]$$$$\Leftrightarrow (a_i-1)\times k\equiv c\mod p,i=[1, 8]\Leftrightarrow k\equiv \dfrac{c}{a_i-1}\mod p,i=[1, 8]$$<p>Như vậy, ta hoàn toàn có thể biến đổi dãy trên thành dãy số hệ số nhân</p>$$C^{(i)}_{t+1}\equiv a_i\times C^{(i)}_t\mod p,i=[1, 8]$$<p>, với $C_i = X_i+\dfrac{c}{a_i-1}\mod p,i=[1, 8]$</p><p>Do đó, tổng S biến đổi thành:</p>$$S\equiv \displaystyle \sum_{j=1}^8 K_ja^i_j-D\mod p$$<p>Có nghĩa là nếu ta lấy từng cặp hiệu của S đôi một liên tiếp thì nó sẽ khử D
($\Delta S_i=S_{i+1}-S_i$), để lại tổng của các thừa số thỏa mãn hồi quy tuyến tính bậc 8 với đa thức đặc trưng là:</p>$$m(x)=\displaystyle \prod_{j=1}^8(x-a_j)\in \mathbb{F}_p[x]$$<h4 id=khôi-phục-lại-delta-s_t>Khôi phục lại $\Delta S_t$</h4><p>Theo đề bài, ta sẽ tách $\Delta S_t$ thành $2^{192}\Delta b_t+d_t$ với $d_t\in (-2^{192}, 2^{192})$</p><p>Từ phép hồi quy trên, suy ra được:</p>$$\displaystyle \sum_{k=0}^8c_k\Delta S_{t+k}\equiv 0 \mod p\ \ (1)$$<p>Vì vậy, khi ta sử dụng phép tách trên, $(1)$ sẽ trở thành phương trình đồng dư tuyến tính modulo p với ẩn $d_t$</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sage.all</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;out.txt&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>out</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>A</span> <span class=o>=</span> <span class=n>out</span><span class=p>[</span><span class=s2>&#34;A&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>hints</span> <span class=o>=</span> <span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>hint</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=k>for</span> <span class=n>hint</span> <span class=ow>in</span> <span class=n>out</span><span class=p>[</span><span class=s2>&#34;hints&#34;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=n>last</span> <span class=o>=</span> <span class=n>hints</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=mi>192</span>
</span></span><span class=line><span class=cl><span class=n>hints</span> <span class=o>=</span> <span class=p>[</span><span class=n>hints</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>hints</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>hints</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>ct</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=s2>&#34;ct&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=s2>&#34;iv&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>rand1</span><span class=p>,</span> <span class=n>rand2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nb>int</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=n>rand1</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span> <span class=o>+</span> <span class=nb>int</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=n>rand2</span><span class=p>,</span> <span class=mi>8</span><span class=p>),</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=o>=</span><span class=n>iv</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>ct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=n>PolynomialRing</span><span class=p>(</span><span class=n>GF</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=s2>&#34;x&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>rec</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=n>prod</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>a</span> <span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=n>A</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>L</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>0</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=p>)]</span> <span class=o>+</span> <span class=n>rec</span> <span class=o>+</span> <span class=p>[</span><span class=mi>0</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>hints</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rec</span><span class=p>)</span> <span class=o>-</span> <span class=n>i</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>hints</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rec</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span> <span class=o>+</span> <span class=p>[[</span><span class=n>p</span> <span class=o>*</span> <span class=nb>int</span><span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>j</span><span class=p>)</span> <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>hints</span><span class=p>))]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rec</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>L</span> <span class=o>=</span> <span class=n>Matrix</span><span class=p>(</span><span class=n>ZZ</span><span class=p>,</span> <span class=n>L</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>B</span> <span class=o>=</span> <span class=n>L</span><span class=o>.</span><span class=n>LLL</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>yprime</span> <span class=o>=</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>192</span><span class=p>)</span> <span class=o>*</span> <span class=n>vector</span><span class=p>(</span><span class=n>ZZ</span><span class=p>,</span> <span class=n>hints</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Byprime</span> <span class=o>=</span> <span class=n>B</span> <span class=o>*</span> <span class=n>yprime</span>
</span></span><span class=line><span class=cl><span class=n>v</span> <span class=o>=</span> <span class=n>vector</span><span class=p>(</span><span class=n>ZZ</span><span class=p>,</span> <span class=p>[</span><span class=nb>round</span><span class=p>(</span><span class=n>i</span> <span class=o>/</span> <span class=n>p</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>Byprime</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>Bzprime</span> <span class=o>=</span> <span class=n>v</span> <span class=o>*</span> <span class=n>p</span> <span class=o>-</span> <span class=n>Byprime</span>
</span></span><span class=line><span class=cl><span class=n>zprime</span> <span class=o>=</span> <span class=p>(</span><span class=n>B</span> <span class=o>**</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span> <span class=o>*</span> <span class=n>Bzprime</span>
</span></span><span class=line><span class=cl><span class=c1># print([len(bin(i)) for i in zprime]) - debug - should be around 192</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>xprime</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>yprime</span> <span class=o>+</span> <span class=n>zprime</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>xprime</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=o>-</span><span class=n>vector</span><span class=p>(</span><span class=n>rec</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>*</span> <span class=n>vector</span><span class=p>(</span><span class=n>xprime</span><span class=p>[</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rec</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span> <span class=p>:]))</span> <span class=o>%</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rand1</span> <span class=o>=</span> <span class=p>((</span><span class=n>last</span> <span class=o>+</span> <span class=n>xprime</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>])</span> <span class=o>%</span> <span class=n>p</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>192</span>
</span></span><span class=line><span class=cl><span class=n>rand2</span> <span class=o>=</span> <span class=p>((</span><span class=n>last</span> <span class=o>+</span> <span class=n>xprime</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=n>xprime</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>%</span> <span class=n>p</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>192</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>r1</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>rand1</span> <span class=o>-</span> <span class=mi>4</span><span class=p>,</span> <span class=n>rand1</span> <span class=o>+</span> <span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>r2</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>rand2</span> <span class=o>-</span> <span class=mi>4</span><span class=p>,</span> <span class=n>rand2</span> <span class=o>+</span> <span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>flag</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>r1</span><span class=p>,</span> <span class=n>r2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=sa>b</span><span class=s2>&#34;ictf&#34;</span> <span class=ow>in</span> <span class=n>flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><pre><code>Flag: ictf{y3t_an07h3r_lcg_ch411_7b24ac314588057bfd4b70b10585a277}
</code></pre><h2 id=bigger-rsa>Bigger-RSA</h2><p><img src=https://hackmd.io/_uploads/HkRU3tD3eg.png loading=lazy alt=image></p><p><code>bigger_rsa.sage</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>getPrime</span><span class=p>,</span> <span class=n>bytes_to_long</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>secrets</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl><span class=n>e</span> <span class=o>=</span> <span class=mh>0x10001</span>
</span></span><span class=line><span class=cl><span class=n>N</span> <span class=o>=</span> <span class=mi>64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;ictf</span><span class=si>{REDACTED}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=n>secrets</span><span class=o>.</span><span class=n>token_bytes</span><span class=p>((</span><span class=n>n</span> <span class=o>*</span> <span class=mi>63</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>flag</span><span class=p>))</span> <span class=o>+</span> <span class=n>flag</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ps</span> <span class=o>=</span> <span class=p>[</span><span class=n>getPrime</span><span class=p>(</span><span class=mi>512</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>m</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>ps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>*=</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>nums</span> <span class=o>=</span> <span class=p>[</span><span class=n>CRT</span><span class=p>([</span><span class=mi>1</span> <span class=o>+</span> <span class=n>secrets</span><span class=o>.</span><span class=n>randbits</span><span class=p>(</span><span class=mi>260</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)],</span><span class=n>ps</span><span class=p>)</span> <span class=k>for</span> <span class=n>__</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>ct</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>bytes_to_long</span><span class=p>(</span><span class=n>flag</span><span class=p>),</span><span class=n>e</span><span class=p>,</span><span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ct=</span><span class=si>{</span><span class=n>ct</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;m=</span><span class=si>{</span><span class=n>m</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;nums=</span><span class=si>{</span><span class=n>nums</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=tài-liệu>Tài liệu</h2><ol><li>(scalar-division): <a class=link href=https://johncremona.github.io/book/fulltext/chapter3.pdf target=_blank rel=noopener>https://johncremona.github.io/book/fulltext/chapter3.pdf</a></li><li>(zkpow):</li></ol><ul><li><a class=link href=https://en.wikipedia.org/wiki/Merkle_tree target=_blank rel=noopener>https://en.wikipedia.org/wiki/Merkle_tree</a></li><li><a class=link href=https://en.wikipedia.org/wiki/Zero-knowledge_proof target=_blank rel=noopener>https://en.wikipedia.org/wiki/Zero-knowledge_proof</a></li><li><a class=link href=https://blog.codeminer42.com/zero-knowledge-proofs-and-merkle-trees-an-overview-before-diving-into-it/ target=_blank rel=noopener>https://blog.codeminer42.com/zero-knowledge-proofs-and-merkle-trees-an-overview-before-diving-into-it/</a></li></ul><ol start=3><li>(leaky-rsa-revenge): <a class=link href=https://crypto.stackexchange.com/questions/11053/rsa-least-significant-bit-oracle-attack target=_blank rel=noopener>https://crypto.stackexchange.com/questions/11053/rsa-least-significant-bit-oracle-attack</a></li><li>(clcg):</li></ol><ul><li><a class=link href=https://en.wikipedia.org/wiki/Linear_congruential_generator target=_blank rel=noopener>https://en.wikipedia.org/wiki/Linear_congruential_generator</a></li><li><a class=link href=https://crypto.stackexchange.com/questions/2086/predicting-values-from-a-linear-congruential-generator target=_blank rel=noopener>https://crypto.stackexchange.com/questions/2086/predicting-values-from-a-linear-congruential-generator</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/ctf/>CTF</a>
<a href=/tags/cryptography/>Cryptography</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/holactf-2025/><div class=article-image><img src=/p/holactf-2025/holactf.9c863f56f24ea2049dc35dc145a8456b_hu_3189ab400ea0ac9b.jpg width=250 height=150 loading=lazy alt="Featured image of post HOLACTF 2025" data-hash="md5-nIY/VvJOogSdw13BRahFaw=="></div><div class=article-details><h2 class=article-title>HOLACTF 2025</h2></div></a></article><article class=has-image><a href=/p/nahamcon-ctf-2025/><div class=article-image><img src=/p/nahamcon-ctf-2025/Certificate.7f8c046c663f2b1fa34b68d95d010fdf_hu_bba9b22fc0efc29c.png width=250 height=150 loading=lazy alt="Featured image of post NahamCon CTF 2025" data-hash="md5-f4wEbGY/Kx+jS2jZXQEP3w=="></div><div class=article-details><h2 class=article-title>NahamCon CTF 2025</h2></div></a></article><article class=has-image><a href=/p/wannagame-cyber-knight-2025/><div class=article-image><img src=/p/wannagame-cyber-knight-2025/w1cyber.a4069297ed7a29deb08708dacbe2eab2_hu_20105d278e73481c.png width=250 height=150 loading=lazy alt="Featured image of post WannaGame Cyber Knight 2025" data-hash="md5-pAaSl+16Kd6whwjay+Lqsg=="></div><div class=article-details><h2 class=article-title>WannaGame Cyber Knight 2025</h2></div></a></article><article><a href=/p/wannagame-nmlt/><div class=article-details><h2 class=article-title>WannaGame NMLT</h2></div></a></article><article class=has-image><a href=/p/dicectf-2025/><div class=article-image><img src=/p/dicectf-2025/dicectf.6d8ee4df8edecb6635d487f03ca4cc4c_hu_649dec51335a5483.png width=250 height=150 loading=lazy alt="Featured image of post DiceCTF 2025" data-hash="md5-bY7k347ey2Y11IfwPKTMTA=="></div><div class=article-details><h2 class=article-title>DiceCTF 2025</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 r1muru</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>