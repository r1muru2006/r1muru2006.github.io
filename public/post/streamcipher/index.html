<!doctype html>
<html
  lang="en-us" 
  data-theme-mode="auto"
  >
  <head><meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/><title>
  Is stream encryption secure? | r1muru
</title>
<meta name="description" content="Today I will go over some stream ciphers (Chacha20-Poly1305, RC4) and learn how they can be exploited by attackers."/><script>
  window.siteConfig = JSON.parse("{\"anchor_icon\":null,\"base\":\"https://r1muru2006.github.io/\",\"clipboard\":{\"copyright\":{\"count\":50,\"enable\":false,\"license_type\":\"by-nc-sa\"},\"fail\":{\"en\":\"Copy failed (ﾟ⊿ﾟ)ﾂ\",\"ja\":\"コピー失敗 (ﾟ⊿ﾟ)ﾂ\",\"pt-br\":\"Falha ao copiar (ﾟ⊿ﾟ)ﾂ\",\"zh-cn\":\"复制失败 (ﾟ⊿ﾟ)ﾂ\",\"zh-tw\":\"複製失敗 (ﾟ⊿ﾟ)ﾂ\"},\"success\":{\"en\":\"Copy successfully (*^▽^*)\",\"ja\":\"コピー成功 (*^▽^*)\",\"pt-br\":\"Copiado com sucesso (*^▽^*)\",\"zh-cn\":\"复制成功 (*^▽^*)\",\"zh-tw\":\"複製成功 (*^▽^*)\"}},\"code_block\":{\"expand\":true},\"icon_font\":false,\"outdate\":{\"daysago\":180,\"enable\":false,\"message\":{\"en\":\"This article was last updated on {time}. Please note that the content may no longer be applicable.\",\"ja\":\"この記事は最終更新日：{time}。記載内容が現在有効でない可能性がありますのでご注意ください。\",\"pt-br\":\"Este artigo foi atualizado pela última vez em {time}. Observe que o conteúdo pode não ser mais aplicável.\",\"zh-cn\":\"本文最后更新于 {time}，请注意文中内容可能已不适用。\",\"zh-tw\":\"本文最後更新於 {time}，請注意文中內容可能已不適用。\"}}}");
  
</script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  rel="preload"
  as="style"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
/>
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
  media="print"
  onload="this.media='all'"
/>
<link
    rel="stylesheet"
    href="https://npm.webcache.cn/@fortawesome/fontawesome-free@7.1.0/css/regular.min.css"
    integrity="sha384-4qYppzjH8EiA&#43;cGdaubu2vL7Rk8WGiqCSj7oRuP1uwtFWkfKNHD20lPfcrbQc8dU" crossorigin="anonymous"/><link
    rel="stylesheet"
    href="https://npm.webcache.cn/@fortawesome/fontawesome-free@7.1.0/css/solid.min.css"
    integrity="sha384-wbMWab3UDSPm2kvIgVOn/d9KPTecgPU1&#43;Nb3zoQrm/oVu0EkPL6IaKinjbwW0rum" crossorigin="anonymous"/><link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/@fortawesome/fontawesome-free@7.1.0/css/brands.min.css"
    integrity="sha384-KTGeC2hIMzpeQakhsmzB9bZfhCD5xZZCgI1iZH6f/O457SxzlkzTQg/WXFNoi3ih" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/@fortawesome/fontawesome-free@7.1.0/css/v5-font-face.min.css"
    integrity="sha384-nJ1ThfldViXoLpJ6jlKcP2beas8BMbYq26SG9Hi8cH89bZi4RZ644v7helMCqJxd" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/@fortawesome/fontawesome-free@7.1.0/css/v4-font-face.min.css"
    integrity="sha384-UlkrhOIvZxJFd4MElSUp7ow6/RUeYKi/orfCZIRRiOENFuQPIAA3T3HjYfmBRhNq" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><link rel="stylesheet" href="/css/loader.min.ac746e154f756f8220326eeb52a719f142ab038be5a8ddf30ea5ef15ef2356ea.css" />
<meta property="og:type" content="website" />
  <meta property="og:title" content="Is stream encryption secure? | r1muru" />
  <meta
    property="og:description"
    content="Today I will go over some stream ciphers (Chacha20-Poly1305, RC4) and learn how they can be exploited by attackers."
  />
  <meta property="og:url" content="https://r1muru2006.github.io/post/streamcipher/" />
  <meta
    property="og:site_name"
    content="r1muru&#39;s blog"
  />
  <meta
    property="og:image"
    content="/images/StreamCipher/background.png"
  />
  <meta property="article:author" content="r1muru" />
  <meta property="article:published_time" content="2025-11-25T14:33:54&#43;07:00" />
  <meta property="article:modified_time" content="2025-11-25T14:33:54&#43;07:00" /><meta property="article:tag" content="ResearchCryptography" /><meta name="twitter:card" content="summary" />
  <meta name="twitter:image" content="/images/StreamCipher/background.png" />
<link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/main.min.fea35ec1dbb9520d5824bd8fcc5533a29acc2b60c759cf3ea9f2c705d51073c8.css" />
<link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css"
    integrity="sha384-IfxC36XL/toUyJ939C73PcgMuRzAZuIzZxE38drsmO5p6jD7ei&#43;Zx/1oA/0l8ysE" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/katex@0.16.24/dist/katex.min.css"
    integrity="sha384-tTgKLjMYmJr94v8qu2PE5MUGSMbyN2xiH266JUB3gpm8vnnJywd1dWSOEfrFz&#43;YI" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><script
    src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js"
    integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script><link
    rel="stylesheet"
    href="https://npm.webcache.cn/@reimujs/aos@0.1.2/dist/aos.css"
    integrity="sha384-GMRP93c6Hkz9JVKGAuRR3nTS7M07RwPgTFenXiosjq2VbVgvdDNcz1g6Mkj8AONa" crossorigin="anonymous"/><link
    rel="stylesheet"
    href="https://npm.webcache.cn/aplayer@1.10.1/dist/APlayer.min.css"
    integrity="sha384-tLMkTWh2pfXNWGFlUS0w1TFtRG5xZ9lPWFOooj&#43;vDDLIL&#43;xBGQU/voDBY5XE2lVh" crossorigin="anonymous"/></head>
  <body><div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi rotate"><img src="/images/loading.svg" alt="loading" /></div><div class="loading-word">Loading...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var loaderEl = document.getElementById('loader');
    var startLoading = () => {
      time = Date.now();
      loaderEl.classList.remove("loading");
    }
    var hideLoader = () => {
      document.body.style.overflow = 'auto';
      loader.classList.add('loading');
    };

    var endLoading = () => {
      if (!time) {
        hideLoader();
      } else {
        if (Date.now() - time > 500) {
          time = null;
          hideLoader();
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    loaderEl.addEventListener('click', endLoading);
  </script><div id="copy-tooltip"></div>
<div id="lang-tooltip">
This article does not have a corresponding language version
</div>
<div id="heatmap-tooltip"></div><div id="container">
      <div id="wrap"><div id="header-nav">
  <nav id="main-nav" aria-label="Primary navigation"><a class="main-nav-link-wrap" href="/">
        <div class='main-nav-icon icon '>&#xf015;</div>
        <span class="main-nav-link">Home</span>
      </a><a class="main-nav-link-wrap" href="/archives">
        <div class='main-nav-icon icon '>&#xf187;</div>
        <span class="main-nav-link">Archives</span>
      </a><a class="main-nav-link-wrap" href="/about">
        <div class='main-nav-icon icon '>&#xf007;</div>
        <span class="main-nav-link">About</span>
      </a><a id="main-nav-toggle" class="nav-icon" aria-label="Toggle navigation" role="button"></a>
  </nav>
  <nav id="sub-nav" aria-label="Secondary navigation"><a id="nav-search-btn" class="nav-icon popup-trigger" title="Search" aria-label="Search"></a></nav></div>
<header id="header" aria-label="Site header"><picture></picture>
    <img  fetchpriority="high" src="/images/StreamCipher/background.png" alt="Is stream encryption secure?"><div id="header-outer">
    <div id="header-title"><span id="logo">
            <h1 data-aos="slide-up">Is stream encryption secure?</h1>
          </span><h2 id="subtitle-wrap" data-aos="slide-down"></h2></div>
  </div>
</header><div id="content"
          aria-label="Page content"
          class="sidebar-left"
            ><aside id="sidebar" aria-label="Sidebar"><div class="sidebar-wrapper-container sticky"><meting-js
        theme="var(--color-link)"
        id="8668604226"server="netease"type="playlist"fixed="false"autoplay="true"loop="all"order="list"preload="auto"volume="0.7"list-folded="false">
      </meting-js><div class="sidebar-wrapper">
    <div
      class="sidebar-wrap"
      data-aos="fade-up"
    ><div class="sidebar-toc-sidebar"><h3 class="toc-title">Contents</h3>
<div class="sidebar-toc-wrapper toc-div-class">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#chacha20-poly1305">Chacha20-Poly1305</a>
      <ul>
        <li><a href="#algorithm">Algorithm</a></li>
        <li><a href="#security">Security</a></li>
      </ul>
    </li>
    <li><a href="#rc4">RC4</a>
      <ul>
        <li><a href="#algorithm-1">Algorithm</a></li>
        <li><a href="#security-1">Security</a></li>
      </ul>
    </li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
</div></div>
          <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img
    data-src="/avatar/avatar.png"
    data-sizes="auto"
    alt="r1muru"
    class="lazyload"
  />
  <div class="sidebar-author-name">r1muru</div>
  <div class="sidebar-description">Life is not fair, get used to it</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div><div class="sidebar-state-number">13</div>
  </div>
  <a class="sidebar-state-category" href="/categories/" aria-label="sidebar-state-category-link">
    <div>Categories</div>
    <div class="sidebar-state-number">
      3
    </div>
  </a>
  <a class="sidebar-state-tag" href="/tags/" aria-label="sidebar-state-tag-link">
    <div>Tags</div>
    <div class="sidebar-state-number">11</div>
  </a>
</div>
<div class="sidebar-social"><div class="icon-discord sidebar-social-icon">
      <a
        href="https://discordapp.com/users/r1muru2006"
        itemprop="url"
        target="_blank"
        aria-label="discord"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-email sidebar-social-icon">
      <a
        href="cuongchu200@gmail.com"
        itemprop="url"
        target="_blank"
        aria-label="email"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-facebook sidebar-social-icon">
      <a
        href="https://www.facebook.com/chu.cuong.732399"
        itemprop="url"
        target="_blank"
        aria-label="facebook"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-github sidebar-social-icon">
      <a
        href="https://github.com/r1muru2006"
        itemprop="url"
        target="_blank"
        aria-label="github"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-instagram sidebar-social-icon">
      <a
        href="https://www.instagram.com/r1murun0pr0"
        itemprop="url"
        target="_blank"
        aria-label="instagram"
        rel="noopener nofollow noreferrer"
      ></a>
    </div></div>
<div class="sidebar-menu"><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/"
        aria-label="Home"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf015;</div>
      <div class="sidebar-menu-link">Home</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/archives"
        aria-label="Archives"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf187;</div>
      <div class="sidebar-menu-link">Archives</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/about"
        aria-label="About"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf007;</div>
      <div class="sidebar-menu-link">About</div>
    </div></div>
</div><div class="sidebar-btn-wrapper" style="position:static">
            <div class="sidebar-toc-btn current"></div>
            <div class="sidebar-common-btn"></div>
          </div></div>
  </div><div class="sidebar-widget"></div></div></aside>
<section id="main" aria-label="Main content"><article
  class="h-entry article"
  itemscope
  itemtype="https://schema.org/BlogPosting"
>
  <div
    class="article-inner"
    data-aos="fade-up"
  >
    <div class="article-meta"><div class="article-date">
  <span
    class="article-date-link icon-calendar"
    data-aos="zoom-in"
  >
    <time datetime="2025-11-25 14:33:54 &#43;0700 &#43;07" itemprop="datePublished"
      >2025-11-25</time
    >
    <time style="display: none;" id="post-update-time"
      >2025-11-25</time
    >
  </span></div>
<div class="article-category"><a
      class="article-category-link"
      href="/categories/learning"
      data-aos="zoom-in"
      >LEARNING</a
    ></div>
</div><div class="hr-line"></div><div class="e-content article-entry" itemprop="articleBody"><h2 id="chacha20-poly1305">
<a class="header-anchor" href="#chacha20-poly1305"></a>
Chacha20-Poly1305
</h2><p>ChaCha20-Poly1305 architecture consists of two main components, the stream cipher ChaCha20 and the authentication mechanism Poly1305 by the same author D.J. Berstein. The two building blocks of the construction, the algorithms Poly1305 and ChaCha20, were both independently designed, in 2005 and 2008.</p>
<h3 id="algorithm">
<a class="header-anchor" href="#algorithm"></a>
Algorithm
</h3><h4 id="chacha20">
<a class="header-anchor" href="#chacha20"></a>
Chacha20
</h4><p>The ChaCha20 algorithm uses ChaCha20 block functions to generate the encryption keystream.
<img src="/images/StreamCipher/encrypt.png" alt="images"></p>
<p>The input of the ChaCha20 block function is a 4x4 word matrix described as in this figure:
<img src="/images/StreamCipher/input.png" alt="images"></p>
<p>More details in figure a are 128 bit constant <em>C</em> (4-word), 256 bit key <em>K</em> (8-word), 32 bit counter parameter <em>Ctr</em> (1 word), 96 bit nonce <em>N</em> (3 words). Then perform 20 loops alternatingly executing the column round transformations according to figure b and the diagonal round transformations according to figure c.</p>
<p>These two circular shifts are implemented by a single QUARTERROUND transformation (cross or column shift based on the input index to the QUARTERROUND function) as shown in this:
<img src="/images/StreamCipher/quarterround.png" alt="images"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">chacha20_quarter_round</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">^=</span> <span class="n">a</span><span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="p">((</span><span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">^=</span> <span class="n">c</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">^=</span> <span class="n">a</span><span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="p">((</span><span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">^=</span> <span class="n">c</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span>
</span></span></code></pre></div><p>In 20 loops, each loop performs 8 operations QUARTERROUND and the order is: QUARTERROUND from 1 to 4 performs column rotation, while QUARTERROUND from 5 to 8 performs cross rotation. The output of the 20-loop block is 16 words, which are added to the 16 input words modulo $2^{32}$ to generate 16 key words. The 16 key words are XORed with the 16 plaintext words to obtain 16 ciphertext words.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">chacha20_block</span><span class="p">(</span><span class="n">key32</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">counter</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nonce12</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">u32</span><span class="p">(</span><span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span> <span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x61707865</span><span class="p">,</span> <span class="mh">0x3320646e</span><span class="p">,</span> <span class="mh">0x79622d32</span><span class="p">,</span> <span class="mh">0x6b206574</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span><span class="p">(</span><span class="n">key32</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span> <span class="n">u32</span><span class="p">(</span><span class="n">key32</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]),</span> <span class="n">u32</span><span class="p">(</span><span class="n">key32</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">]),</span> <span class="n">u32</span><span class="p">(</span><span class="n">key32</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span><span class="p">(</span><span class="n">key32</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">20</span><span class="p">]),</span> <span class="n">u32</span><span class="p">(</span><span class="n">key32</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">]),</span> <span class="n">u32</span><span class="p">(</span><span class="n">key32</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">28</span><span class="p">]),</span> <span class="n">u32</span><span class="p">(</span><span class="n">key32</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">32</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="n">counter</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span><span class="p">(</span><span class="n">nonce12</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span> <span class="n">u32</span><span class="p">(</span><span class="n">nonce12</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]),</span> <span class="n">u32</span><span class="p">(</span><span class="n">nonce12</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># column rounds</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">chacha20_quarter_round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">chacha20_quarter_round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">chacha20_quarter_round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">chacha20_quarter_round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># diagonal rounds</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">chacha20_quarter_round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">chacha20_quarter_round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">chacha20_quarter_round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">chacha20_quarter_round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span></code></pre></div><h4 id="poly1305">
<a class="header-anchor" href="#poly1305"></a>
Poly1305
</h4><p>Poly1305 is a message authentication cipher (MAC) to ensure the authenticity and integrity of data.
The input key is divided into 2 parts called r and s, each part is 128 bits long. The pair (r,s) must be unique and unguessable for each call.</p>
<p>The input message is divided into 16-byte blocks (the last block can be padded with 0 bits), the 16-byte blocks are padded with 1 byte with value 0x01 to 17 bytes, calculations are performed on these blocks with r on the Z() field to create an accumulator.
<img src="/images/StreamCipher/poly1305.png" alt="images"></p>
<p>Finally the value s is added to the accumulator and the 128 bits are extracted as the authentication tag.
<img src="/images/StreamCipher/poly1305_2.png" alt="images"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_clamp_r</span><span class="p">(</span><span class="n">r_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Convert 16-byte little-endian r_bytes to integer and apply clamp per RFC.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_bytes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;r must be 16 bytes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">r_bytes</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># clamp mask: r &amp;= 0x0ffffffc0ffffffc0ffffffc0fffffff</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># expressed as integer:</span>
</span></span><span class="line"><span class="cl">    <span class="n">clamp_mask</span> <span class="o">=</span> <span class="mh">0x0ffffffc0ffffffc0ffffffc0fffffff</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="n">clamp_mask</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">poly1305_mac</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Compute Poly1305 tag for message `msg` using 32-byte one-time key `key` (r||s).
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns 16-byte tag.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Poly1305 key must be 32 bytes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">r_bytes</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">s_bytes</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">32</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">_clamp_r</span><span class="p">(</span><span class="n">r_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">s_bytes</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">)</span>  <span class="c1"># s added at the end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Process message in 16-byte blocks</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">block</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># n = int.from_bytes(block, &#39;little&#39;) + (1 &lt;&lt; (8*len(block)))</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># append the 1 byte in little-endian domain:</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">acc</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">P130</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">acc</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">%</span> <span class="n">P130</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Final tag = (acc + s) mod 2^128</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">acc</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">128</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span> <span class="o">=</span> <span class="n">tag_int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tag</span>
</span></span></code></pre></div><p>Here is the implement of this algorithm: <a href="https://github.com/r1muru2006/r1muru2006.github.io/tree/main/static/script/streamcipher/Chacha20_Poly1305/chacha20_poly1305.py">Link</a></p>
<h3 id="security">
<a class="header-anchor" href="#security"></a>
Security
</h3><p>ChaCha20-Poly1305 is generally secure and offers better resistance to timing attacks than AES-GCM. However, like GCM, its security relies strictly on unique nonces. While specific implementations like SSH face vulnerabilities such as the Terrapin attack, this post focuses on a fundamental flaw: exploiting ChaCha20-Poly1305 under nonce reuse.</p>
<p>First of all, I will create a challenge named <a href="https://github.com/r1muru2006/r1muru2006.github.io/blob/main/static/script/streamcipher/Chacha20_Poly1305/chall.py">chall.py</a> to generate 2 pairs of (ct, tag) using a known plaintext. This allows us to recover the keystream and eventually forge a tag for a new message.</p>
<p>In a typical oracle scheme, while the secret key is reused across multiple messages, the nonce must remain unique. However, if the Nonce is inadvertently reused, the Poly1305 one-time key pair $(r, s)$ remains identical for those messages. If we capture two distinct pairs of (ct, tag) generated from the same $(r, s)$, we can set up the following system of equations:</p>
$$tag_1 = \text{Poly1305}(r, s, m_1) = (P_1(r) \pmod p) + s \pmod{2^{128}}$$<p>
</p>
$$tag_2 = \text{Poly1305}(r, s, m_2) = (P_2(r) \pmod p) + s \pmod{2^{128}}$$<p>
$\text{where } p = 2^{130} - 5, P_j(r)=\sum\text{block}_{j, i} \cdot r^i \pmod p$</p>
<p>By subtracting one equation from the other, we can eliminate the unknown scalar $s$. However, because the final addition of $s$ is performed modulo $2^{128}$, while the polynomial evaluation is modulo $2^{130}-5$, we must account for the modular difference. This results in the following polynomial equation:
</p>
$$tag_1 - tag_2 = \sum (\text{block}_{1,i} - \text{block}_{2,i}) \cdot r^i + k \cdot 2^{128} \pmod p$$<p>Here, $k$ represents the &ldquo;carry&rdquo; difference resulting from the modulo $2^{128}$ addition, typically falling within the range $k \in \{-4, \dots, 4\}$.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_poly</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">padded</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">((</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span> <span class="o">=</span> <span class="n">padded</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_int</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">16</span><span class="p">]</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">16</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">r_sym</span><span class="o">**</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeffs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">poly_diff</span> <span class="o">=</span> <span class="n">make_poly</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="o">-</span> <span class="n">make_poly</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delta_tag</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t2</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">roots</span> <span class="o">=</span> <span class="p">(</span><span class="n">poly_diff</span> <span class="o">-</span> <span class="p">(</span><span class="n">delta_tag</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">128</span><span class="p">))</span><span class="o">.</span><span class="n">roots</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">r_val</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">clamp_check</span><span class="p">(</span><span class="n">r_int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">val_poly1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">make_poly</span><span class="p">(</span><span class="n">c1</span><span class="p">)(</span><span class="n">r_int</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">s_cand</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">val_poly1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">128</span>
</span></span><span class="line"><span class="cl">            <span class="n">val_poly2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">make_poly</span><span class="p">(</span><span class="n">c2</span><span class="p">)(</span><span class="n">r_int</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">val_poly2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">128</span> <span class="o">==</span> <span class="n">s_cand</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">r_int</span><span class="p">,</span> <span class="n">s_cand</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">r</span><span class="p">:</span> <span class="k">break</span>
</span></span></code></pre></div><p><strong>Recovering the Key:</strong>
By iterating through the small range of possible $k$ values, we can solve for the roots of this polynomial to find potential candidates for $r$. The correct $r$ can be identified by verifying it against the specific formatting rules of the Poly1305 &ldquo;clamp&rdquo; function. Once $r$ is found, we can trivially derive $s$ from either original tag. With the complete $(r, s)$ pair, we can now forge valid tags for any arbitrary message.</p>
<p>All of the code I put in <a href="https://github.com/r1muru2006/r1muru2006.github.io/tree/main/static/script/streamcipher/Chacha20_Poly1305">here</a></p>
<h2 id="rc4">
<a class="header-anchor" href="#rc4"></a>
RC4
</h2><p>RC4 (also known as ARC4 or ARCFOUR, meaning Alleged RC4) is a stream cipher. While it is remarkable for its simplicity and speed in software, multiple vulnerabilities have been discovered in RC4, rendering it insecure.
RC4 is a stream cipher designed by Ronald Rivest of RSA Security in 1987.</p>
<h3 id="algorithm-1">
<a class="header-anchor" href="#algorithm-1"></a>
Algorithm
</h3><p>To generate the keystream, the cipher makes use of a secret internal state which consists of two parts:</p>
<ol>
<li>A permutation of all 256 possible bytes (denoted &ldquo;S&rdquo;).</li>
<li>Two 8-bit index-pointers (denoted &ldquo;i&rdquo; and &ldquo;j&rdquo;).</li>
</ol>
<p>The permutation is initialized with a variable-length <code>key</code>, typically between 40 and 2048 bits, using the key-scheduling algorithm (KSA). Then using the pseudo-random generation algorithm (PRGA) to generate <code>keystream</code>.
<img src="/images/StreamCipher/RC4.png" alt="images"></p>
<h4 id="key-scheduling-algorithm-ksa">
<a class="header-anchor" href="#key-scheduling-algorithm-ksa"></a>
Key-Scheduling Algorithm (KSA)
</h4><p>Let $S$ be a state array of size $N=256$ and $K$ be the secret key array of length $L$ bytes, where $1 \le L \le 256$.</p>
<ol>
<li>Initialization (Identity Permutation)
$$\forall i \in \{0, \dots, N-1\}: S[i] \leftarrow i$$</li>
<li>KSA Scrambling Loop</li>
</ol>
<p>Let $j \leftarrow 0$.
For $i$ from $0$ to $N-1$:</p>
$$j \leftarrow (j + S[i] + K[i \bmod L]) \bmod N$$<p>
</p>
$$\text{Swap}(S[i], S[j])$$<p>
<strong>Observation on Key Equivalence:</strong>
Due to the modulo operator $i \bmod L$, the key $K$ functions as a circular buffer.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rc4_ksa</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">keylen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">keylen</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">S</span>
</span></span></code></pre></div><h4 id="pseudo-random-generation-algorithm-prga">
<a class="header-anchor" href="#pseudo-random-generation-algorithm-prga"></a>
Pseudo-Random Generation Algorithm (PRGA)
</h4><p>Let $S$ be the permutation state array of size $N=256$ and  $i, j$ be indices initialized to $0$.</p>
<p>For each byte $k$ required:
</p>
$$\begin{aligned}
i &\leftarrow (i + 1) \bmod N \\
j &\leftarrow (j + S[i]) \bmod N \\
S &\leftarrow \text{Swap}(S[i], S[j]) \\
t &\leftarrow (S[i] + S[j]) \bmod N \\
K_k &\leftarrow S[t]
\end{aligned}$$<p>Since the index $i$ increments deterministically ($i \leftarrow i + 1$), so:</p>
$$\forall x \in \{0, \dots, 255\}, \text{the element } S[x] \text{ is swapped at least once per } 256 \text{ rounds.}$$<p>This ensures that the permutation $S$ continues to evolve significantly throughout the keystream generation, rather than settling into a short cycle.
<img src="/images/StreamCipher/PRGA.png" alt="images"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rc4_prga</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">K</span> <span class="o">=</span> <span class="n">S</span><span class="p">[(</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">K</span>
</span></span></code></pre></div><p>Here is the implement of this algorithm: <a href="https://github.com/r1muru2006/r1muru2006.github.io/tree/main/static/script/streamcipher/RC4/RC4.py">Link</a>.</p>
<h3 id="security-1">
<a class="header-anchor" href="#security-1"></a>
Security
</h3><p>Unlike a modern stream cipher, RC4 does not take a separate nonce alongside the key. This means that if a single long-term key is to be used to securely encrypt multiple streams, the protocol must specify how to combine the nonce and the long-term key to generate the stream key for RC4.</p>
<p>While it is remarkable for its simplicity and speed in software, multiple vulnerabilities have been discovered in RC4. Particularly problematic uses of RC4 have led to very insecure protocols such as WEP.</p>
<p><img src="/images/StreamCipher/WEP.png" alt="images">
Wired Equivalent Privacy (WEP) was included as the privacy component of the original IEEE 802.11 standard ratified in 1997. WEP uses the stream cipher RC4 for confidentiality, and the CRC-32 checksum for integrity.</p>
<p>However, RC4&rsquo;s weak key schedule then gives rise to related-key attacks, like the Fluhrer, Mantin and Shamir attack.</p>
<h4 id="fluhrer-mantin-and-shamir-attack">
<a class="header-anchor" href="#fluhrer-mantin-and-shamir-attack"></a>
Fluhrer, Mantin and Shamir attack
</h4><p>The basis of the FMS attack lies in the use of weak initialization vectors (IVs) used with RC4.</p>
<p>When the WEP security standard was designed for WiFi in the 90s, engineers specified the following key structure: <code>IV</code> length is fixed at 24 bits (3 bytes) and <code>session key</code> is the result of the concatenation of the <code>IV</code> and the <code>Root Key</code> together.</p>
<p>Therefore, the <code>Root Key</code> will start at index 3 so if we want to recover the <code>Root Key</code>, we could start at this index. After a few calculation, we choose $(i, 255, x)$ as the weak IV with i is the index of the bytes we want to recover, x is an arbitrary integer number.</p>
<p>For example, we set <code>i = A + 3</code>. Assuming length of the <code>Root Key</code> smaller than 256. The key now is: [A + 3, 255, x, rk[0], rk[1],&hellip;]</p>
<p>Here are some of the first rounds as we process the KSA:</p>
<ul>
<li>Round 1:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">- Start with S:
</span></span><span class="line"><span class="cl">+-----------------------------------------------+
</span></span><span class="line"><span class="cl">|  0  |  1  |  2  |  3  |  4  |  5  | ... | 255 |
</span></span><span class="line"><span class="cl">+-----------------------------------------------+
</span></span><span class="line"><span class="cl">   ^
</span></span><span class="line"><span class="cl">  i,j
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- Calculate:
</span></span><span class="line"><span class="cl">j = (j + S[i] + key[i % keylen]) &amp; 0xFF = (0 + S[0] + key[0]) &amp; 0xFF = (0 + 0 + A + 3) % 255 = A + 3
</span></span><span class="line"><span class="cl">Swap S[0] and S[A + 3]: S[0] = A + 3, S[A + 3] = 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- S becomes:
</span></span><span class="line"><span class="cl">+--------------------------------------------+
</span></span><span class="line"><span class="cl">| A + 3 |  1  |  2  | ...  |  0  | ... | 255 |
</span></span><span class="line"><span class="cl">+--------------------------------------------+
</span></span><span class="line"><span class="cl">    ^                         ^
</span></span><span class="line"><span class="cl">    i                         j
</span></span></code></pre></div><ul>
<li>Round 2:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">- Start with S:
</span></span><span class="line"><span class="cl">+--------------------------------------------+
</span></span><span class="line"><span class="cl">| A + 3 |  1  |  2  | ...  |  0  | ... | 255 |
</span></span><span class="line"><span class="cl">+--------------------------------------------+
</span></span><span class="line"><span class="cl">           ^                  ^
</span></span><span class="line"><span class="cl">           i                  j
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- Calculate:
</span></span><span class="line"><span class="cl">j = (j + S[i] + key[i % keylen]) &amp; 0xFF = (A + 3 + S[1] + key[1]) &amp; 0xFF = (A + 3 + 1 + 255) % 256 = A + 3
</span></span><span class="line"><span class="cl">Swap S[1] and S[A + 3]: S[1] = 0, S[A + 3] = 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- S becomes:
</span></span><span class="line"><span class="cl">+--------------------------------------------+
</span></span><span class="line"><span class="cl">| A + 3 |  0  |  2  | ...  |  1  | ... | 255 |
</span></span><span class="line"><span class="cl">+--------------------------------------------+
</span></span><span class="line"><span class="cl">           ^                  ^
</span></span><span class="line"><span class="cl">           i                  j
</span></span></code></pre></div><ul>
<li>Round 3:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">- Start with S:
</span></span><span class="line"><span class="cl">+--------------------------------------------+
</span></span><span class="line"><span class="cl">| A + 3 |  0  |  2  | ...  |  1  | ... | 255 |
</span></span><span class="line"><span class="cl">+--------------------------------------------+
</span></span><span class="line"><span class="cl">                 ^            ^
</span></span><span class="line"><span class="cl">                 i            j
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- Calculate:
</span></span><span class="line"><span class="cl">j = (j + S[i] + key[i % keylen]) &amp; 0xFF = (A + 3 + S[2] + key[2]) &amp; 0xFF = (A + 3 + 2 + x) % 256 = X,
</span></span><span class="line"><span class="cl">with X = (x + A + 5) % 256
</span></span><span class="line"><span class="cl">Swap S[2] and S[X]: S[2] = X, S[X] = 2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- S becomes:
</span></span><span class="line"><span class="cl">+-----------------------------------------------------------+
</span></span><span class="line"><span class="cl">| A + 3 |  0  |  X  |  1  |  4  |  5  | ... | 2 | ... | 255 |
</span></span><span class="line"><span class="cl">+-----------------------------------------------------------+
</span></span><span class="line"><span class="cl">                 ^                            ^
</span></span><span class="line"><span class="cl">                 i                            j
</span></span></code></pre></div><ul>
<li>Round 4:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">- Start with S:
</span></span><span class="line"><span class="cl">+-------------------------------------------------------------+
</span></span><span class="line"><span class="cl">| A + 3 |  0  |  X  |  1  |  4  |  5  | ... |  2  | ... | 255 |
</span></span><span class="line"><span class="cl">+-------------------------------------------------------------+
</span></span><span class="line"><span class="cl">                       ^                       ^
</span></span><span class="line"><span class="cl">                       i                       j
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- Calculate:
</span></span><span class="line"><span class="cl">j = (j + S[i] + key[i % keylen]) &amp; 0xFF = (X + S[3] + key[3]) &amp; 0xFF = (X + 1 + rk[0]) % 256 = Q,
</span></span><span class="line"><span class="cl">with Q = (X + 1 + rk[0]) % 256 = (x + A + 6 + rk[0]) % 256
</span></span><span class="line"><span class="cl">Swap S[3] and S[Q]: S[3] = Q, S[X] = 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- S becomes:
</span></span><span class="line"><span class="cl">+-------------------------------------------------------------+
</span></span><span class="line"><span class="cl">| A + 3 |  0  |  X  |  Q  |  4  |  5  | ... |  1  | ... | 255 |
</span></span><span class="line"><span class="cl">+-------------------------------------------------------------+
</span></span><span class="line"><span class="cl">                       ^                       ^
</span></span><span class="line"><span class="cl">                       i                       j
</span></span></code></pre></div><p>Then continue until A + 3 rounds and if this still has S[0] = A + 3, S[1] = 0, it could lead to the first bytes of the keystream after PRGA is: </p>
$$K[0] = S[S[1] + S[S[1]] = S[0+S[0]]=S[3] =Q$$<p> We can recover the byte with index A of the <code>Root Key</code>: </p>
$$j_{A+4}=j_{A+3}+S_{A+3}[A+3]+K[A+3] \pmod {256} \\ \Leftrightarrow Q = j_{A+3} + S_{A+3}[A+3] + \text{rk}[A]\pmod {256} \\ \Leftrightarrow \text{rk}[A]= Q - j_{A+3} - S_{A+3}[A+3] \pmod {256}$$<p>
When I calculate the probability of the case $Q = j_{A+4}$, it came out to be 5% compared to the normal $\dfrac{1}{256}$ because of my chosen weak IV. The probability that a value will not be touched in a random loop is approximately $1-\dfrac{1}{256}$ and survives 256 rounds is $(1-\dfrac{1}{256})^{256}=e^{-1}$. Finally, we require three specific values ($S[0], S[1]$, and the target) to remain unmoved, the combined probability is derived as $(e^{-1})^3 = e^{-3} \approx 0.0497$.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">S</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span> <span class="o">%</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">o0</span><span class="p">,</span> <span class="n">o1</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="ow">and</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">o0</span> <span class="o">!=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">o1</span> <span class="o">!=</span> <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">key_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">ks</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">    <span class="n">probs</span><span class="p">[</span><span class="n">key_byte</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span></code></pre></div><p>From there, we count each case x to see which value appears most often and determine that it is the one we are looking for.</p>
<p>The implement, challenge and also the solution I put in <a href="https://github.com/r1muru2006/r1muru2006.github.io/tree/main/static/script/streamcipher/RC4">here</a>.</p>
<h2 id="reference">
<a class="header-anchor" href="#reference"></a>
Reference
</h2><ol>
<li><a href="https://tailieu.antoanthongtin.gov.vn/Files/files/site-2/files/Hemadongcoxacthuc.pdf">Hệ mã dòng có xác thực</a></li>
<li><a href="https://en.wikipedia.org/wiki/ChaCha20-Poly1305#Security">Security of Chacha20-Poly1305 by Wikipedia</a></li>
<li><a href="https://en.wikipedia.org/wiki/RC4">RC4 by Wikipedia</a></li>
<li><a href="https://en.wikipedia.org/wiki/Related-key_attack">Related-key attack by Wikipedia</a></li>
<li><a href="https://en.wikipedia.org/wiki/Fluhrer,_Mantin_and_Shamir_attack">Fluhrer, Mantin and Shamir attack by Wikipedia</a></li>
<li><a href="https://link.springer.com/content/pdf/10.1007/3-540-45537-X_1.pdf">Weaknesses in the Key Scheduling Algorithm of RC4</a></li>
</ol>
</div>
    <footer class="article-footer"><blockquote class="article-copyright"><p><strong><span class="icon-user icon"></span>Author: </strong>r1muru</p><p>
      <strong><span class="icon-link icon"></span>Permalink: </strong><a href="https://r1muru2006.github.io/post/streamcipher/">https://r1muru2006.github.io/post/streamcipher/</a>
    </p><p>
      
      <strong><span class="icon-copyright icon"></span>License: </strong>
      All articles on this blog are licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener nofollow noreferrer" target="_blank"><span class="icon-creative-commons"></span>BY-NC-SA</a> license agreement unless otherwise stated. Please indicate the source when reprinting!
    </p>
    <span class="icon-creative-commons article-copyright-bg"></span></blockquote>
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/tags/research"
        rel="tag"
        >RESEARCH</a
      >
    </li><li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/tags/cryptography"
        rel="tag"
        >CRYPTOGRAPHY</a
      >
    </li></ul>
</footer>
  </div><nav
    id="article-nav"
    aria-label="Article navigation"
    data-aos="fade-up"
  ><div class="article-nav-link-wrap left"><img
            data-src="/images/patriot/patriot.png"
            data-sizes="auto"
            alt="Patriot CTF 2025"
            class="lazyload"
          /><a
          href="/post/patriotctf2025/"
          aria-label="Prev:Patriot CTF 2025"
          title="Prev:Patriot CTF 2025"
        ></a>
        <div class="article-nav-caption">Prev</div>
        <h3 class="article-nav-title">Patriot CTF 2025</h3>
      </div><div class="article-nav-link-wrap right"><img
            data-src="/images/WannaChamp/avatar.png"
            data-sizes="auto"
            alt="WannaGame Championship 2025"
            class="lazyload"
          /><a
          href="/post/wannagamechampionship2025/"
          aria-label="Next:WannaGame Championship 2025"
          title="Next:WannaGame Championship 2025"
        ></a>
        <div class="article-nav-caption">Next</div>
        <h3 class="article-nav-title">WannaGame Championship 2025</h3>
      </div></nav></article></section>
        </div><footer id="footer" aria-label="Site footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info"><div>
      <span class="icon-copyright"></span>2024-2025<span class="footer-info-sep rotate"></span>
      r1muru
    </div><div>
        Powered by&nbsp;<a
          href="https://gohugo.io/"
          target="_blank"
          rel="noopener nofollow noreferrer"
          >Hugo</a
        >&nbsp; Theme.<a
          href="https://github.com/D-Sketon/hugo-theme-reimu"
          target="_blank"
          rel="noopener nofollow noreferrer"
          >Reimu</a
        >
      </div><div>
        <span class="icon-brush"
          >&nbsp;36.2k</span
        >
        &nbsp;|&nbsp;
        <span class="icon-coffee">&nbsp;02:57</span>
      </div><div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv"
          >Number of visits&nbsp;<span
            id="busuanzi_value_site_pv"
          ></span
        ></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv"
          >Number of visitors&nbsp;<span
            id="busuanzi_value_site_uv"
          ></span
        ></span>
      </div></div>
</footer>
<div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div><div id="mask" class="hide"></div>
      </div><nav id="mobile-nav" aria-label="Mobile navigation">
  <div class="sidebar-wrap"><div class="sidebar-toc-sidebar"><h3 class="toc-title">Contents</h3>
<div class="sidebar-toc-wrapper toc-div-class">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#chacha20-poly1305">Chacha20-Poly1305</a>
      <ul>
        <li><a href="#algorithm">Algorithm</a></li>
        <li><a href="#security">Security</a></li>
      </ul>
    </li>
    <li><a href="#rc4">RC4</a>
      <ul>
        <li><a href="#algorithm-1">Algorithm</a></li>
        <li><a href="#security-1">Security</a></li>
      </ul>
    </li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
</div></div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img
    data-src="/avatar/avatar.png"
    data-sizes="auto"
    alt="r1muru"
    class="lazyload"
  />
  <div class="sidebar-author-name">r1muru</div>
  <div class="sidebar-description">Life is not fair, get used to it</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div><div class="sidebar-state-number">13</div>
  </div>
  <a class="sidebar-state-category" href="/categories/" aria-label="sidebar-state-category-link">
    <div>Categories</div>
    <div class="sidebar-state-number">
      3
    </div>
  </a>
  <a class="sidebar-state-tag" href="/tags/" aria-label="sidebar-state-tag-link">
    <div>Tags</div>
    <div class="sidebar-state-number">11</div>
  </a>
</div>
<div class="sidebar-social"><div class="icon-discord sidebar-social-icon">
      <a
        href="https://discordapp.com/users/r1muru2006"
        itemprop="url"
        target="_blank"
        aria-label="discord"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-email sidebar-social-icon">
      <a
        href="cuongchu200@gmail.com"
        itemprop="url"
        target="_blank"
        aria-label="email"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-facebook sidebar-social-icon">
      <a
        href="https://www.facebook.com/chu.cuong.732399"
        itemprop="url"
        target="_blank"
        aria-label="facebook"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-github sidebar-social-icon">
      <a
        href="https://github.com/r1muru2006"
        itemprop="url"
        target="_blank"
        aria-label="github"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-instagram sidebar-social-icon">
      <a
        href="https://www.instagram.com/r1murun0pr0"
        itemprop="url"
        target="_blank"
        aria-label="instagram"
        rel="noopener nofollow noreferrer"
      ></a>
    </div></div>
<div class="sidebar-menu"><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/"
        aria-label="Home"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf015;</div>
      <div class="sidebar-menu-link">Home</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/archives"
        aria-label="Archives"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf187;</div>
      <div class="sidebar-menu-link">Archives</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/about"
        aria-label="About"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf007;</div>
      <div class="sidebar-menu-link">About</div>
    </div></div>
</div></div><div class="sidebar-btn-wrapper">
        <div class="sidebar-toc-btn current"></div>
        <div class="sidebar-common-btn"></div>
      </div></nav>
</div><div class="site-search">
        <div class="reimu-popup popup">
          <div class="reimu-search">
            <div class="reimu-search-input-icon"></div>
            <div id="reimu-search-input"></div>
            <div class="popup-btn-close"></div>
          </div>
          <div class="reimu-results">
            <div id="reimu-stats"></div>
            <div id="reimu-hits"></div>
            <div id="reimu-pagination" class="reimu-pagination"></div>
          </div>
          <img class="reimu-bg" src="/images/reimu.png" />
        </div>
      </div><script
    src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js"
    integrity="sha384-3gT/vsepWkfz/ff7PpWNUeMzeWoH3cDhm/A8jM7ouoAK0/fP/9bcHHR5kHq2nf&#43;e" crossorigin="anonymous"></script><script
    src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js"
    integrity="sha384-J08i8An/QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script><script src="/js/main.js" integrity="" crossorigin="anonymous" ></script><script src="/js/aos.js" integrity="" crossorigin="anonymous" ></script><script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", aosInit);
    } else {
      aosInit();
    }
  </script><script src="/js/pjax_main.js" integrity="" crossorigin="anonymous" data-pjax></script><script>
    var ALGOLIA_CONFIG = {
      logo: '\/images\/algolia_logo.svg',
      algolia: {
        applicationID: "RAY96S32HW",
        apiKey: "53e71efc7b6ca695cdb630e780aeae50",
        indexName: "my-blog",
        hits: {
          "per_page": parseInt("10")
        },
        labels: {
          "input_placeholder": 'Search.....',
          "hits_empty": 'No results found for 「${query}」',
          "hits_stats": 'Found ${hits} results (in ${time} ms)'
        }
      }
    };
  </script><script
    src="https://npm.webcache.cn/algoliasearch@4.17.1/dist/algoliasearch-lite.umd.js"
    deferintegrity="sha384-xvLS0jfKuoREs7pqkRI/OI8GcqohO5S&#43;jQz7ZBtQXnsXmD&#43;9jDOOY4cL6dCPzlrk" crossorigin="anonymous"></script><script
    src="https://npm.webcache.cn/@reimujs/instantsearch.js@4.57.0-beta.1/dist/instantsearch.production.min.js"
    deferintegrity="sha384-aagKMe8nkqaP2DYQc8kkYOL5l&#43;M5Q2WH/Uhr4teOh0Ybp0RZj0kUSDm45qPikMjK" crossorigin="anonymous"></script><script src="/js/algolia_search.js" integrity="" crossorigin="anonymous" ></script><script
    src="https://npm.webcache.cn/mouse-firework@0.1.1/dist/index.umd.js"
    integrity="sha384-8LyaidD9GPxQQgLJO/WRw/O2h3BoNq/ApI/ecpvM6RsrCz2qP2ppBXUKihP4V/2d" crossorigin="anonymous"></script><script>
  if (! false  || !window.matchMedia('(max-width: 768px)').matches) {
    if (window.firework) {
      const options = JSON.parse("{\"excludeelements\":[\"a\",\"button\"],\"particles\":[{\"colors\":[\"var(--red-1)\",\"var(--red-2)\",\"var(--red-3)\",\"var(--red-4)\"],\"duration\":[1200,1800],\"easing\":\"easeOutExpo\",\"move\":[\"emit\"],\"number\":20,\"shape\":\"circle\",\"shapeOptions\":{\"alpha\":[0.3,0.5],\"radius\":[16,32]}},{\"colors\":[\"var(--red-0)\"],\"duration\":[1200,1800],\"easing\":\"easeOutExpo\",\"move\":[\"diffuse\"],\"number\":1,\"shape\":\"circle\",\"shapeOptions\":{\"alpha\":[0.2,0.5],\"lineWidth\":6,\"radius\":20}}]}");
      options.excludeElements = options.excludeelements;
      delete options.excludeelements;
      window.firework(options);
    }
  }
</script><script
    src="https://npm.webcache.cn/theme-shokax-pjax@0.0.3/dist/index.umd.js"
    integrity="sha384-xneY1WY8hOfUzswrE4CrYq35N4BdVcxqxwHPr9zawE/jMSCxD&#43;jAPU55x/jj3wlf" crossorigin="anonymous"></script><script src="/js/pjax.js" integrity="" crossorigin="anonymous" ></script>

<div id="lazy-script">
  <div><script data-pjax>
        window.REIMU_POST = {
          author: "r1muru",
          title: "Is stream encryption secure?",
          url: "https:\/\/r1muru2006.github.io\/post\/streamcipher\/",
          description: "Today I will go over some stream ciphers (Chacha20-Poly1305, RC4) and learn how they can be exploited by attackers.",
          cover: "https:\/\/r1muru2006.github.io\/images\/StreamCipher\/background.png",
        };
      </script><script src="/js/insert_highlight.js" integrity="" crossorigin="anonymous" data-pjax></script><script src="/js/tabs.js" integrity="" crossorigin="anonymous" data-pjax></script><script type="module" data-pjax>const PhotoSwipeLightbox = (await safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe-lightbox.esm.min.js", "sha384-DiL6M\/gG\u002bwmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF\/N6lrZi\/")).default;const initPswp = (gallery, children) => {
          if (_$$(`${gallery} ${children}`).length > 0) {
            new PhotoSwipeLightbox({
              gallery,
              children,pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")}).init();
          }
        }
        const pswp = () => {
          initPswp('.article-entry', 'a.article-gallery-item');
          initPswp('.article-gallery', 'a.article-gallery-item');
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script><script
    src="https://npm.webcache.cn/katex@0.16.24/dist/katex.min.js"
    data-pjaxintegrity="sha384-MWNUH0WmtsYGhn2cbH6ELRCbf9LG3QDqCC&#43;gqPB3IBNO35xjZK3Ejb6oONRpDbPg" crossorigin="anonymous"></script><script
    src="https://npm.webcache.cn/katex@0.16.24/dist/contrib/auto-render.min.js"
    data-pjaxintegrity="sha384-hCXGrW6PitJEwbkoStFjeJxv&#43;fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script><script data-pjax>
          var renderMath = () => {
            if (!window.renderMathInElement) return;
            window.renderMathInElement(_$("article"), {
              delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "\\[", right: "\\]", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
              ],
            });
          };
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", renderMath, { once: true });
          } else {
            renderMath();
          }
        </script></div>
</div><script
    src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js"
    asyncintegrity="sha384-0M75wtSkhjIInv4coYlaJU83&#43;OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id&#43;S" crossorigin="anonymous"></script><script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        for (let registration of registrations) {
          registration.unregister();
        }
      });
    }
  </script><script>
  const reimuCopyright = String.raw`
   ______     ______     __     __    __     __  __    
  /\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
  \ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
   \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
    \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                    
  `;
  console.log(String.raw`%c ${reimuCopyright}`, "color: #ff5252;");
  console.log(
    "%c Theme.Reimu" + " %c https://github.com/D-Sketon/hugo-theme-reimu ",
    "color: white; background: #ff5252; padding:5px 0;",
    "padding:4px;border:1px solid #ff5252;",
  );
</script><script
    src="https://npm.webcache.cn/aplayer@1.10.1/dist/APlayer.min.js"
    integrity="sha384-gdGYZwHnfJM54evoZhpO0s6ZF5BQiybkiyW7VXr&#43;h5UfruuRL/aORyw&#43;5&#43;HZoU6e" crossorigin="anonymous"></script><script>
    if (! false  || !window.matchMedia('(max-width: 768px)').matches) {
      if (window.matchMedia('(max-width: 959px)').matches) {
        const meting = _$('meting-js');
        if (meting) {
          meting.setAttribute('fixed', 'true');
          const aside = meting.parentNode?.parentNode;
          if (aside?.tagName === 'ASIDE') {
            meting.parentNode.removeChild(meting);
            document.body.appendChild(meting);
          }
        }
      }
      const script = document.createElement('script');
      script.src = "https:\/\/npm.webcache.cn\/meting@2.0.1\/dist\/Meting.min.js";
      script.integrity = "sha384-ASVlpKF80A22OXTK3tfEjZm1EL6uFMKIC4p8\u002b0maanw1S\/IyB\u002bY4JG\u002bZDU7GpKE8";
      script.crossOrigin = "anonymous";
      document.body.appendChild(script);
    }
  </script></body>
</html>
